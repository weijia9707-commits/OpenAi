<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Editor - Free Online | No Ads, No Watermark, No Signup | ÂõæÁâáÁºñËæë | Web Toolbox</title>
    <meta name="description" content="Free online image editor with crop, flip, rotate, color adjustment, filters, annotations, and text overlay. Features grayscale, invert, blur, sharpen, emboss, pixelate effects. ‚úÖ No ads ‚úÖ No signup ‚úÖ No watermark. Runs entirely in your browser.">
    <meta name="keywords" content="image editor,online photo editor,crop image,image filter,color adjustment,annotation,text overlay,background removal,free tool, no ads, no signup, no watermark, no login, free unlimited, browser-based, no installation, local processing">
    <meta name="author" content="heyuan110">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://www.heyuan110.com/web-toolbox/image-editor.html">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üñºÔ∏è</text></svg>">

    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://www.heyuan110.com/web-toolbox/image-editor.html">
    <meta property="og:title" content="Image Editor - Free Online | No Ads, No Watermark, No Signup | ÂõæÁâáÁºñËæë">
    <meta property="og:description" content="Free online image editor with crop, filter, color adjustment, and annotation features.">
    <meta property="og:image" content="https://www.heyuan110.com/web-toolbox/screenshots/image-editor.png">
    <meta property="og:locale" content="en_US">
    <meta property="og:site_name" content="Web Toolbox">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Image Editor - Free Online | No Ads, No Watermark, No Signup | ÂõæÁâáÁºñËæë">
    <meta name="twitter:description" content="Free online image editor with crop, filter, color adjustment, and annotation.">
    <meta name="twitter:image" content="https://www.heyuan110.com/web-toolbox/screenshots/image-editor.png">

    <!-- JSON-LD -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Online Image Editor",
        "url": "https://www.heyuan110.com/web-toolbox/image-editor.html",
        "description": "Online image editor with crop, filter, color adjustment, and annotation features",
        "applicationCategory": "DesignApplication",
        "operatingSystem": "Web Browser",
        "offers": {"@type": "Offer", "price": "0", "priceCurrency": "USD"},
        "featureList": ["No ads", "No signup required", "No watermark", "100% browser-based", "Unlimited usage", "Local processing"],
        "author": {"@type": "Person", "name": "heyuan110"}
    }
    </script>

    <!-- FAQ JSON-LD -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "FAQPage",
        "mainEntity": [
            {
                "@type": "Question",
                "name": "What image formats are supported?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "Supports JPG, PNG, WebP, GIF, BMP and other common image formats."
                }
            },
            {
                "@type": "Question",
                "name": "Can I undo edits?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "Yes, undo and redo functions are supported."
                }
            },
            {
                "@type": "Question",
                "name": "What format is the edited image?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "You can choose to export as JPG, PNG, or WebP format."
                }
            },
            {
                "@type": "Question",
                "name": "Can I batch edit images?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "Not currently supported, only one image can be edited at a time."
                }
            },
            {
                "@type": "Question",
                "name": "Are images uploaded to a server?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "No, all editing is done locally in your browser."
                }
            },
            {
                "@type": "Question",
                "name": "Is this tool really free with no ads?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "Yes, 100% free with no ads, no registration, no watermark, and no usage limits. All processing happens locally in your browser ‚Äî your data is never uploaded to any server."
                }
            }
        ]
    }
    </script>

    <!-- Cropper.js -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.1/dist/cropper.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-card: #0f3460;
            --bg-hover: #1a4a7a;
            --text-primary: #eee;
            --text-secondary: #aaa;
            --accent: #e94560;
            --accent-light: #ff6b6b;
            --success: #4ecdc4;
            --warning: #ffd93d;
            --border: #2a2a4a;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Â§¥ÈÉ® */
        .header {
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-card));
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
            position: relative;
        }

        /* ËØ≠Ë®ÄÂàáÊç¢Âô® */
        .lang-switcher { position: absolute; top: 0; right: 0; }
        .lang-dropdown { position: relative; display: inline-block; }
        .lang-current { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; color: #e0e0e0; transition: all 0.3s ease; }
        .lang-current:hover { background: rgba(255,255,255,0.15); }
        .lang-menu { position: absolute; top: 100%; right: 0; margin-top: 4px; background: #1e1e2e; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 4px; min-width: 140px; opacity: 0; visibility: hidden; transform: translateY(-10px); transition: all 0.3s ease; z-index: 1000; }
        .lang-dropdown.active .lang-menu { opacity: 1; visibility: visible; transform: translateY(0); }
        .lang-btn { display: block; width: 100%; padding: 10px 16px; background: none; border: none; color: #e0e0e0; font-size: 14px; text-align: left; cursor: pointer; border-radius: 6px; transition: background 0.2s ease; }
        .lang-btn:hover { background: rgba(255,255,255,0.1); }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo h1 {
            font-size: 1.3rem;
            background: linear-gradient(135deg, var(--accent), var(--accent-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .back-link {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
        }

        .back-link:hover {
            color: var(--accent);
        }

        /* ÊåâÈíÆ */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent), var(--accent-light));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(233, 69, 96, 0.3);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
        }

        .btn-success {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ‰∏ªÂ∏ÉÂ±Ä */
        .main-container {
            display: flex;
            height: calc(100vh - 60px);
        }

        /* Â∑¶‰æßÂ∑•ÂÖ∑Ê†è */
        .toolbar {
            width: 60px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 10px 0;
        }

        .tool-btn {
            width: 100%;
            padding: 12px 0;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            font-size: 0.7rem;
            transition: all 0.2s;
        }

        .tool-btn:hover {
            color: var(--text-primary);
            background: var(--bg-card);
        }

        .tool-btn.active {
            color: var(--accent);
            background: var(--bg-card);
            border-left: 3px solid var(--accent);
        }

        .tool-btn .icon {
            font-size: 1.2rem;
        }

        /* ÁîªÂ∏ÉÂå∫Âüü */
        .canvas-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #0a0a15;
            position: relative;
            overflow: hidden;
        }

        .canvas-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow: auto;
        }

        #mainCanvas {
            max-width: 100%;
            max-height: 100%;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        /* ‰∏ä‰º†Âå∫Âüü */
        .upload-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px;
            text-align: center;
        }

        .upload-box {
            border: 2px dashed var(--border);
            border-radius: 16px;
            padding: 60px 80px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .upload-box:hover,
        .upload-box.drag-over {
            border-color: var(--accent);
            background: rgba(233, 69, 96, 0.1);
        }

        .upload-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .upload-title {
            font-size: 1.3rem;
            margin-bottom: 10px;
        }

        .upload-desc {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Âè≥‰æßÈù¢Êùø */
        .panel {
            width: 280px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .panel-section {
            margin-bottom: 20px;
        }

        .panel-section-title {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        /* ÊªëÂùó */
        .slider-group {
            margin-bottom: 15px;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 0.85rem;
        }

        .slider-value {
            color: var(--accent);
            font-weight: 500;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            background: var(--bg-card);
            border-radius: 3px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
        }

        /* Êª§ÈïúÁΩëÊ†º */
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .filter-item {
            background: var(--bg-card);
            border: 2px solid transparent;
            border-radius: 8px;
            padding: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .filter-item:hover {
            border-color: var(--border);
        }

        .filter-item.active {
            border-color: var(--accent);
        }

        .filter-preview {
            width: 100%;
            aspect-ratio: 1;
            background: linear-gradient(45deg, #666 25%, transparent 25%),
                        linear-gradient(-45deg, #666 25%, transparent 25%),
                        linear-gradient(45deg, transparent 75%, #666 75%),
                        linear-gradient(-45deg, transparent 75%, #666 75%);
            background-size: 10px 10px;
            background-position: 0 0, 0 5px, 5px -5px, -5px 0;
            border-radius: 4px;
            margin-bottom: 4px;
            overflow: hidden;
        }

        .filter-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .filter-name {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        /* È¢úËâ≤ÈÄâÊã©Âô® */
        .color-picker-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        input[type="color"] {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background: none;
        }

        /* Êìç‰ΩúÊåâÈíÆÁªÑ */
        .action-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .action-btn {
            padding: 10px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .action-btn:hover {
            background: var(--bg-hover);
            border-color: var(--accent);
        }

        .action-btn .icon {
            font-size: 1.2rem;
        }

        /* ÊñáÂ≠óËæìÂÖ• */
        .text-input {
            width: 100%;
            padding: 10px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .text-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Â∫ïÈÉ®Â∑•ÂÖ∑Ê†è */
        .bottom-bar {
            padding: 10px 15px;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .zoom-btn {
            width: 30px;
            height: 30px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 1rem;
        }

        .zoom-btn:hover {
            background: var(--bg-hover);
        }

        .zoom-value {
            font-size: 0.85rem;
            min-width: 50px;
            text-align: center;
        }

        /* Ë£ÅÂàáÊ®°Âºè */
        .crop-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            flex-direction: column;
            z-index: 100;
        }

        .crop-overlay.active {
            display: flex;
        }

        .crop-actions {
            padding: 15px;
            background: var(--bg-secondary);
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .crop-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow: auto;
            min-height: 0;
        }

        .crop-container img {
            max-width: 100%;
            max-height: 100%;
        }

        .crop-ratio-btns {
            display: flex;
            gap: 8px;
        }

        .ratio-btn {
            padding: 6px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.8rem;
        }

        .ratio-btn:hover,
        .ratio-btn.active {
            border-color: var(--accent);
            color: var(--accent);
        }

        /* ÂéÜÂè≤ËÆ∞ÂΩï */
        .history-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: var(--bg-card);
            border-radius: 6px;
            margin-bottom: 6px;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .history-item:hover {
            background: var(--bg-hover);
        }

        .history-item.current {
            border: 1px solid var(--accent);
        }

        /* Êä†ÂõæÊ®°Âºè */
        .chroma-controls {
            margin-top: 10px;
        }

        /* ÈöêËóèÂÖÉÁ¥† */
        .hidden {
            display: none !important;
        }

        /* ÂìçÂ∫îÂºè */
        @media (max-width: 900px) {
            .main-container {
                flex-direction: column;
            }

            .toolbar {
                width: 100%;
                flex-direction: row;
                overflow-x: auto;
            }

            .tool-btn {
                padding: 8px 12px;
            }

            .panel {
                width: 100%;
                max-height: 300px;
            }
        }

        /* ÊñáÂ≠óÂõæÂ±ÇÊ†∑Âºè */
        .text-layer {
            position: absolute;
            cursor: move;
            user-select: none;
            padding: 5px 10px;
            border: 2px dashed transparent;
            transition: border-color 0.2s;
        }

        .text-layer:hover,
        .text-layer.selected {
            border-color: var(--accent);
        }

        .text-layer .delete-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 20px;
            height: 20px;
            background: var(--accent);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            font-size: 12px;
            display: none;
        }

        .text-layer:hover .delete-btn,
        .text-layer.selected .delete-btn {
            display: block;
        }

        #textLayerContainer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #textLayerContainer .text-layer {
            pointer-events: auto;
            white-space: nowrap;
        }

        /* ÁªòÂõæÁîªÂ∏É */
        #drawCanvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }

        #drawCanvas.active {
            pointer-events: auto;
            cursor: crosshair;
        }
        .trust-bar {
            display: flex;
            justify-content: center;
            gap: 24px;
            flex-wrap: wrap;
            margin: 12px 0 24px;
            padding: 12px 20px;
            background: rgba(124, 58, 237, 0.1);
            border: 1px solid rgba(124, 58, 237, 0.2);
            border-radius: 12px;
        }
        .trust-item {
            font-size: 13px;
            color: #a78bfa;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="lang-switcher">
            <div class="lang-dropdown" id="langDropdown">
                <div class="lang-current" id="langCurrent">üåê English</div>
                <div class="lang-menu">
                    <button class="lang-btn" data-lang="en">üá∫üá∏ English</button>
                    <button class="lang-btn" data-lang="zh-CN">üá®üá≥ ‰∏≠Êñá</button>
                    <button class="lang-btn" data-lang="fr">üá´üá∑ Fran√ßais</button>
                    <button class="lang-btn" data-lang="es">üá™üá∏ Espa√±ol</button>
                </div>
            </div>
        </div>
        <div class="logo">
            <span style="font-size: 1.5rem;">üñºÔ∏è</span>
            <h1 data-i18n="title">Online Image Editor</h1>
        </div>
        <div class="header-actions">
            <a href="index.html" class="back-link" data-i18n="backToToolbox">‚Üê Back to Toolbox</a>
            <label for="fileInput" class="btn btn-secondary" data-i18n="openImage">üìÇ Open Image</label>
            <button id="undoBtn" class="btn btn-secondary" disabled data-i18n="undo">‚Ü© Undo</button>
            <button id="redoBtn" class="btn btn-secondary" disabled data-i18n="redo">‚Ü™ Redo</button>
            <button id="resetBtn" class="btn btn-secondary" disabled data-i18n="reset">üîÑ Reset</button>
            <button id="downloadBtn" class="btn btn-success" disabled data-i18n="saveImage">üíæ Save Image</button>
        </div>
    </header>

    <div class="trust-bar" style="max-width: 1200px; margin: 12px auto 24px; padding: 12px 20px;">
        <span class="trust-item" data-i18n="trust_users">üåç Used by 50,000+ users</span>
        <span class="trust-item" data-i18n="trust_rating">‚≠ê 4.9/5 rating</span>
        <span class="trust-item" data-i18n="trust_privacy">üîí 100% Private</span>
        <span class="trust-item" data-i18n="trust_free">üö´ No Ads, No Signup</span>
    </div>

    <!-- ÂäüËÉΩÁâπÁÇπÂå∫Âùó -->
    <section class="features-section" style="max-width: 1200px; margin: 0 auto; padding: 24px 20px; border-bottom: 1px solid var(--border);">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px;">
            <div style="display: flex; align-items: flex-start; gap: 12px;">
                <span style="font-size: 24px; flex-shrink: 0;">üîí</span>
                <div>
                    <h3 style="font-size: 15px; color: var(--text-primary); margin-bottom: 6px;" data-i18n="featureBasicTitle">100% Free & Private</h3>
                    <p style="font-size: 13px; color: var(--text-secondary); line-height: 1.5;" data-i18n="featureBasicDesc">No ads, no signup, no watermark. Everything runs locally in your browser. Your data never leaves your device.</p>
                </div>
            </div>
            <div style="display: flex; align-items: flex-start; gap: 12px;">
                <span style="font-size: 24px; flex-shrink: 0;">üé®</span>
                <div>
                    <h3 style="font-size: 15px; color: var(--text-primary); margin-bottom: 6px;" data-i18n="featureFilterTitle">Filter Effects</h3>
                    <p style="font-size: 13px; color: var(--text-secondary); line-height: 1.5;" data-i18n="featureFilterDesc">Brightness, contrast, saturation, blur and more filters</p>
                </div>
            </div>
            <div style="display: flex; align-items: flex-start; gap: 12px;">
                <span style="font-size: 24px; flex-shrink: 0;">üìù</span>
                <div>
                    <h3 style="font-size: 15px; color: var(--text-primary); margin-bottom: 6px;" data-i18n="featureTextTitle">Text Watermark</h3>
                    <p style="font-size: 13px; color: var(--text-secondary); line-height: 1.5;" data-i18n="featureTextDesc">Add custom text watermarks with adjustable font and position</p>
                </div>
            </div>
            <div style="display: flex; align-items: flex-start; gap: 12px;">
                <span style="font-size: 24px; flex-shrink: 0;">üëÅÔ∏è</span>
                <div>
                    <h3 style="font-size: 15px; color: var(--text-primary); margin-bottom: 6px;" data-i18n="featurePreviewTitle">Live Preview</h3>
                    <p style="font-size: 13px; color: var(--text-secondary); line-height: 1.5;" data-i18n="featurePreviewDesc">All adjustments preview instantly, what you see is what you get</p>
                </div>
            </div>
        </div>
    </section>

    <input type="file" id="fileInput" accept="image/*" style="display: none;">

    <main class="main-container">
        <!-- Â∑¶‰æßÂ∑•ÂÖ∑Ê†è -->
        <aside class="toolbar">
            <button class="tool-btn active" data-tool="adjust">
                <span class="icon">üé®</span>
                <span data-i18n="toolAdjust">Adjust</span>
            </button>
            <button class="tool-btn" data-tool="filter">
                <span class="icon">‚ú®</span>
                <span data-i18n="toolFilter">Filter</span>
            </button>
            <button class="tool-btn" data-tool="crop">
                <span class="icon">‚úÇÔ∏è</span>
                <span data-i18n="toolCrop">Crop</span>
            </button>
            <button class="tool-btn" data-tool="transform">
                <span class="icon">üîÑ</span>
                <span data-i18n="toolTransform">Transform</span>
            </button>
            <button class="tool-btn" data-tool="draw">
                <span class="icon">‚úèÔ∏è</span>
                <span data-i18n="toolDraw">Draw</span>
            </button>
            <button class="tool-btn" data-tool="text">
                <span class="icon">üìù</span>
                <span data-i18n="toolText">Text</span>
            </button>
            <button class="tool-btn" data-tool="chroma">
                <span class="icon">üé≠</span>
                <span data-i18n="toolChroma">Chroma</span>
            </button>
        </aside>

        <!-- ÁîªÂ∏ÉÂå∫Âüü -->
        <section class="canvas-area">
            <div class="canvas-wrapper" id="canvasWrapper">
                <!-- ‰∏ä‰º†Âå∫Âüü -->
                <div class="upload-area" id="uploadArea">
                    <div class="upload-box" id="uploadBox">
                        <div class="upload-icon">üñºÔ∏è</div>
                        <h2 class="upload-title" data-i18n="uploadTitle">Drag image here</h2>
                        <p class="upload-desc" data-i18n="uploadDesc">Or click to select image file (supports JPG, PNG, WebP, GIF)</p>
                    </div>
                </div>

                <!-- ‰∏ªÁîªÂ∏É -->
                <canvas id="mainCanvas" class="hidden"></canvas>
                <canvas id="drawCanvas" class="hidden"></canvas>
                <!-- ÊñáÂ≠óÂõæÂ±ÇÂÆπÂô® -->
                <div id="textLayerContainer"></div>
            </div>

            <!-- Ë£ÅÂàáË¶ÜÁõñÂ±Ç -->
            <div class="crop-overlay" id="cropOverlay">
                <div class="crop-actions">
                    <div class="crop-ratio-btns">
                        <button class="ratio-btn active" data-ratio="free" data-i18n="ratioFree">Free</button>
                        <button class="ratio-btn" data-ratio="1">1:1</button>
                        <button class="ratio-btn" data-ratio="1.333">4:3</button>
                        <button class="ratio-btn" data-ratio="1.777">16:9</button>
                        <button class="ratio-btn" data-ratio="0.75">3:4</button>
                    </div>
                    <button class="btn btn-primary" id="applyCrop" data-i18n="applyCrop">‚úì Apply Crop</button>
                    <button class="btn btn-secondary" id="cancelCrop" data-i18n="cancel">‚úï Cancel</button>
                </div>
                <div class="crop-container">
                    <img id="cropImage" src="">
                </div>
            </div>

            <!-- Â∫ïÈÉ®Áä∂ÊÄÅÊ†è -->
            <div class="bottom-bar" id="bottomBar" style="display: none;">
                <div class="image-info">
                    <span id="imageDimensions">0 √ó 0</span>
                </div>
                <div class="zoom-controls">
                    <button class="zoom-btn" id="zoomOut">‚àí</button>
                    <span class="zoom-value" id="zoomValue">100%</span>
                    <button class="zoom-btn" id="zoomIn">+</button>
                    <button class="zoom-btn" id="zoomFit">‚ä°</button>
                </div>
            </div>
        </section>

        <!-- Âè≥‰æßÈù¢Êùø -->
        <aside class="panel" id="panel">
            <!-- Ë∞ÉËâ≤Èù¢Êùø -->
            <div id="adjustPanel">
                <div class="panel-header" data-i18n="panelAdjust">üé® Adjust</div>
                <div class="panel-content">
                    <div class="panel-section">
                        <div class="slider-group">
                            <div class="slider-label">
                                <span data-i18n="brightness">Brightness</span>
                                <span class="slider-value" id="brightnessValue">0</span>
                            </div>
                            <input type="range" id="brightness" min="-100" max="100" value="0">
                        </div>
                        <div class="slider-group">
                            <div class="slider-label">
                                <span data-i18n="contrast">Contrast</span>
                                <span class="slider-value" id="contrastValue">0</span>
                            </div>
                            <input type="range" id="contrast" min="-100" max="100" value="0">
                        </div>
                        <div class="slider-group">
                            <div class="slider-label">
                                <span data-i18n="saturation">Saturation</span>
                                <span class="slider-value" id="saturationValue">0</span>
                            </div>
                            <input type="range" id="saturation" min="-100" max="100" value="0">
                        </div>
                        <div class="slider-group">
                            <div class="slider-label">
                                <span data-i18n="hue">Hue</span>
                                <span class="slider-value" id="hueValue">0</span>
                            </div>
                            <input type="range" id="hue" min="-180" max="180" value="0">
                        </div>
                        <div class="slider-group">
                            <div class="slider-label">
                                <span data-i18n="exposure">Exposure</span>
                                <span class="slider-value" id="exposureValue">0</span>
                            </div>
                            <input type="range" id="exposure" min="-100" max="100" value="0">
                        </div>
                        <div class="slider-group">
                            <div class="slider-label">
                                <span data-i18n="noise">Noise</span>
                                <span class="slider-value" id="noiseValue">0</span>
                            </div>
                            <input type="range" id="noise" min="0" max="100" value="0">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Êª§ÈïúÈù¢Êùø -->
            <div id="filterPanel" class="hidden">
                <div class="panel-header" data-i18n="panelFilter">‚ú® Filter</div>
                <div class="panel-content">
                    <div class="filter-grid" id="filterGrid">
                        <!-- Êª§ÈïúÈ°πÁõÆÁî± JS ÁîüÊàê -->
                    </div>
                </div>
            </div>

            <!-- Ë£ÅÂàáÈù¢Êùø -->
            <div id="cropPanel" class="hidden">
                <div class="panel-header" data-i18n="panelCrop">‚úÇÔ∏è Crop</div>
                <div class="panel-content">
                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 15px;" data-i18n="cropHint">
                        Click the button below to enter crop mode, drag to adjust crop area
                    </p>
                    <button class="btn btn-primary" id="startCrop" style="width: 100%;" data-i18n="startCrop">Start Crop</button>
                </div>
            </div>

            <!-- ÂèòÊç¢Èù¢Êùø -->
            <div id="transformPanel" class="hidden">
                <div class="panel-header" data-i18n="panelTransform">üîÑ Transform</div>
                <div class="panel-content">
                    <div class="panel-section">
                        <div class="panel-section-title" data-i18n="flip">Flip</div>
                        <div class="action-grid">
                            <button class="action-btn" id="flipH">
                                <span class="icon">‚ÜîÔ∏è</span>
                                <span data-i18n="flipHorizontal">Flip H</span>
                            </button>
                            <button class="action-btn" id="flipV">
                                <span class="icon">‚ÜïÔ∏è</span>
                                <span data-i18n="flipVertical">Flip V</span>
                            </button>
                        </div>
                    </div>
                    <div class="panel-section">
                        <div class="panel-section-title" data-i18n="rotate">Rotate</div>
                        <div class="action-grid">
                            <button class="action-btn" id="rotateL">
                                <span class="icon">‚Ü∫</span>
                                <span data-i18n="rotateLeft">Left 90¬∞</span>
                            </button>
                            <button class="action-btn" id="rotateR">
                                <span class="icon">‚Üª</span>
                                <span data-i18n="rotateRight">Right 90¬∞</span>
                            </button>
                        </div>
                    </div>
                    <div class="panel-section">
                        <div class="slider-group">
                            <div class="slider-label">
                                <span data-i18n="freeRotate">Free Rotate</span>
                                <span class="slider-value" id="rotateValue">0¬∞</span>
                            </div>
                            <input type="range" id="rotateSlider" min="-180" max="180" value="0">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ê†áÊ≥®Èù¢Êùø -->
            <div id="drawPanel" class="hidden">
                <div class="panel-header" data-i18n="panelDraw">‚úèÔ∏è Draw</div>
                <div class="panel-content">
                    <div class="panel-section">
                        <div class="panel-section-title" data-i18n="tools">Tools</div>
                        <div class="action-grid">
                            <button class="action-btn active" data-draw="brush">
                                <span class="icon">üñåÔ∏è</span>
                                <span data-i18n="brush">Brush</span>
                            </button>
                            <button class="action-btn" data-draw="line">
                                <span class="icon">üìè</span>
                                <span data-i18n="line">Line</span>
                            </button>
                            <button class="action-btn" data-draw="rect">
                                <span class="icon">‚¨ú</span>
                                <span data-i18n="rectangle">Rect</span>
                            </button>
                            <button class="action-btn" data-draw="circle">
                                <span class="icon">‚≠ï</span>
                                <span data-i18n="circle">Circle</span>
                            </button>
                            <button class="action-btn" data-draw="arrow">
                                <span class="icon">‚û°Ô∏è</span>
                                <span data-i18n="arrow">Arrow</span>
                            </button>
                            <button class="action-btn" data-draw="eraser">
                                <span class="icon">üßΩ</span>
                                <span data-i18n="eraser">Eraser</span>
                            </button>
                        </div>
                    </div>
                    <div class="panel-section">
                        <div class="color-picker-wrapper">
                            <input type="color" id="drawColor" value="#e94560">
                            <span data-i18n="brushColor">Brush Color</span>
                        </div>
                        <div class="slider-group">
                            <div class="slider-label">
                                <span data-i18n="brushSize">Brush Size</span>
                                <span class="slider-value" id="brushSizeValue">5</span>
                            </div>
                            <input type="range" id="brushSize" min="1" max="50" value="5">
                        </div>
                    </div>
                    <button class="btn btn-secondary" id="clearDraw" style="width: 100%;" data-i18n="clearDraw">Clear Drawing</button>
                </div>
            </div>

            <!-- ÊñáÂ≠óÈù¢Êùø -->
            <div id="textPanel" class="hidden">
                <div class="panel-header" data-i18n="panelText">üìù Text</div>
                <div class="panel-content">
                    <div class="panel-section">
                        <input type="text" class="text-input" id="textInput" data-i18n-placeholder="textPlaceholder" placeholder="Enter text content...">
                        <div class="color-picker-wrapper">
                            <input type="color" id="textColor" value="#ffffff">
                            <span data-i18n="textColor">Text Color</span>
                        </div>
                        <div class="slider-group">
                            <div class="slider-label">
                                <span data-i18n="fontSize">Font Size</span>
                                <span class="slider-value" id="fontSizeValue">32</span>
                            </div>
                            <input type="range" id="fontSize" min="12" max="120" value="32">
                        </div>
                        <select class="text-input" id="fontFamily">
                            <option value="Arial">Arial</option>
                            <option value="Microsoft YaHei">Microsoft YaHei</option>
                            <option value="SimHei">SimHei</option>
                            <option value="SimSun">SimSun</option>
                            <option value="KaiTi">KaiTi</option>
                            <option value="Georgia">Georgia</option>
                            <option value="Times New Roman">Times New Roman</option>
                            <option value="Courier New">Courier New</option>
                        </select>
                        <div style="margin-top: 10px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="textBold"> <span data-i18n="bold">Bold</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin-top: 8px;">
                                <input type="checkbox" id="textShadow"> <span data-i18n="shadow">Shadow</span>
                            </label>
                        </div>
                    </div>
                    <button class="btn btn-primary" id="addText" style="width: 100%;" data-i18n="addText">Add Text</button>
                    <p style="color: var(--text-secondary); font-size: 0.8rem; margin-top: 10px; text-align: center;" data-i18n="textHint">
                        Drag text to adjust position after adding
                    </p>
                    <button class="btn btn-secondary" id="clearText" style="width: 100%; margin-top: 10px;" data-i18n="clearAllText">Clear All Text</button>
                </div>
            </div>

            <!-- Êä†ÂõæÈù¢Êùø -->
            <div id="chromaPanel" class="hidden">
                <div class="panel-header" data-i18n="panelChroma">üé≠ Chroma Key</div>
                <div class="panel-content">
                    <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 15px;" data-i18n="chromaHint">
                        Select background color to remove, adjust tolerance for natural effect
                    </p>
                    <div class="panel-section">
                        <div class="color-picker-wrapper">
                            <input type="color" id="chromaColor" value="#00ff00">
                            <span data-i18n="selectBgColor">Select BG Color</span>
                        </div>
                        <button class="btn btn-secondary" id="pickColor" style="width: 100%; margin-bottom: 10px;" data-i18n="pickFromImage">
                            üéØ Pick from Image
                        </button>
                        <div class="slider-group">
                            <div class="slider-label">
                                <span data-i18n="tolerance">Tolerance</span>
                                <span class="slider-value" id="chromaToleranceValue">30</span>
                            </div>
                            <input type="range" id="chromaTolerance" min="0" max="100" value="30">
                        </div>
                        <div class="slider-group">
                            <div class="slider-label">
                                <span data-i18n="feather">Edge Feather</span>
                                <span class="slider-value" id="chromaFeatherValue">0</span>
                            </div>
                            <input type="range" id="chromaFeather" min="0" max="20" value="0">
                        </div>
                    </div>
                    <button class="btn btn-primary" id="applyChroma" style="width: 100%;" data-i18n="applyChroma">Apply Chroma</button>
                </div>
            </div>
        </aside>
    </main>

    <!-- Cropper.js -->
    <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.1/dist/cropper.min.js"></script>

    <script>
        // ========== Áä∂ÊÄÅÁÆ°ÁêÜ ==========
        const state = {
            originalImage: null,
            currentImage: null,
            history: [],
            historyIndex: -1,
            zoom: 1,
            currentTool: 'adjust',
            adjustments: {
                brightness: 0,
                contrast: 0,
                saturation: 0,
                hue: 0,
                exposure: 0,
                noise: 0
            },
            currentFilter: 'none',
            rotation: 0,
            flipH: false,
            flipV: false,
            textLayers: [],
            drawTool: 'brush',
            drawColor: '#e94560',
            brushSize: 5,
            isDrawing: false,
            cropper: null,
            isPickingColor: false
        };

        // ========== DOM ÂÖÉÁ¥† ==========
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('uploadArea');
        const uploadBox = document.getElementById('uploadBox');
        const mainCanvas = document.getElementById('mainCanvas');
        const drawCanvas = document.getElementById('drawCanvas');
        const canvasWrapper = document.getElementById('canvasWrapper');
        const ctx = mainCanvas.getContext('2d', { willReadFrequently: true });
        const drawCtx = drawCanvas.getContext('2d');
        const bottomBar = document.getElementById('bottomBar');

        // ========== Êª§ÈïúÂÆö‰πâ ==========
        const filters = [
            { id: 'none', name: 'ÂéüÂõæ', apply: null },
            { id: 'grayscale', name: 'ÁÅ∞Â∫¶', apply: (d) => applyGrayscale(d) },
            { id: 'invert', name: 'ÂèçËâ≤', apply: (d) => applyInvert(d) },
            { id: 'sepia', name: 'Ê£ïË§ê', apply: (d) => applySepia(d) },
            { id: 'vintage', name: 'Â§çÂè§', apply: (d) => applyVintage(d) },
            { id: 'cold', name: 'ÂÜ∑Ë∞É', apply: (d) => applyCold(d) },
            { id: 'warm', name: 'ÊöñË∞É', apply: (d) => applyWarm(d) },
            { id: 'blur', name: 'Ê®°Á≥ä', apply: (d, c) => applyBlur(d, c) },
            { id: 'sharpen', name: 'ÈîêÂåñ', apply: (d, c) => applySharpen(d, c) },
            { id: 'emboss', name: 'ÊµÆÈõï', apply: (d, c) => applyEmboss(d, c) },
            { id: 'pixelate', name: 'ÂÉèÁ¥†Âåñ', apply: (d, c) => applyPixelate(d, c) },
            { id: 'edge', name: 'ËæπÁºò', apply: (d, c) => applyEdge(d, c) }
        ];

        // ========== ÂàùÂßãÂåñ ==========
        function init() {
            setupEventListeners();
            generateFilterGrid();
        }

        function setupEventListeners() {
            // Êñá‰ª∂‰∏ä‰º†
            fileInput.addEventListener('change', handleFileSelect);
            uploadBox.addEventListener('click', () => fileInput.click());
            uploadBox.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadBox.classList.add('drag-over');
            });
            uploadBox.addEventListener('dragleave', () => uploadBox.classList.remove('drag-over'));
            uploadBox.addEventListener('drop', handleDrop);

            // Â∑•ÂÖ∑ÂàáÊç¢
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.addEventListener('click', () => switchTool(btn.dataset.tool));
            });

            // Ë∞ÉËâ≤ÊªëÂùó
            ['brightness', 'contrast', 'saturation', 'hue', 'exposure', 'noise'].forEach(param => {
                const slider = document.getElementById(param);
                slider.addEventListener('input', () => {
                    state.adjustments[param] = parseInt(slider.value);
                    document.getElementById(`${param}Value`).textContent = slider.value;
                    applyAllEffects();
                });
            });

            // ÂèòÊç¢ÊåâÈíÆ
            document.getElementById('flipH').addEventListener('click', () => { state.flipH = !state.flipH; applyAllEffects(); saveHistory('Ê∞¥Âπ≥ÁøªËΩ¨'); });
            document.getElementById('flipV').addEventListener('click', () => { state.flipV = !state.flipV; applyAllEffects(); saveHistory('ÂûÇÁõ¥ÁøªËΩ¨'); });
            document.getElementById('rotateL').addEventListener('click', () => rotate(-90));
            document.getElementById('rotateR').addEventListener('click', () => rotate(90));
            document.getElementById('rotateSlider').addEventListener('input', (e) => {
                state.rotation = parseInt(e.target.value);
                document.getElementById('rotateValue').textContent = state.rotation + '¬∞';
                applyAllEffects();
            });
            document.getElementById('rotateSlider').addEventListener('change', () => saveHistory('ÊóãËΩ¨'));

            // Ë£ÅÂàá
            document.getElementById('startCrop').addEventListener('click', startCrop);
            document.getElementById('applyCrop').addEventListener('click', applyCrop);
            document.getElementById('cancelCrop').addEventListener('click', cancelCrop);
            document.querySelectorAll('.ratio-btn').forEach(btn => {
                btn.addEventListener('click', () => setCropRatio(btn.dataset.ratio));
            });

            // Ê†áÊ≥®
            document.querySelectorAll('[data-draw]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('[data-draw]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.drawTool = btn.dataset.draw;
                });
            });
            document.getElementById('drawColor').addEventListener('input', (e) => state.drawColor = e.target.value);
            document.getElementById('brushSize').addEventListener('input', (e) => {
                state.brushSize = parseInt(e.target.value);
                document.getElementById('brushSizeValue').textContent = e.target.value;
            });
            document.getElementById('clearDraw').addEventListener('click', clearDrawCanvas);

            // ÁªòÂõæÁîªÂ∏É‰∫ã‰ª∂
            drawCanvas.addEventListener('mousedown', startDrawing);
            drawCanvas.addEventListener('mousemove', draw);
            drawCanvas.addEventListener('mouseup', stopDrawing);
            drawCanvas.addEventListener('mouseleave', stopDrawing);

            // ÊñáÂ≠ó
            document.getElementById('fontSize').addEventListener('input', (e) => {
                document.getElementById('fontSizeValue').textContent = e.target.value;
            });
            document.getElementById('addText').addEventListener('click', addTextLayer);
            document.getElementById('clearText').addEventListener('click', clearTextLayers);

            // Êä†Âõæ
            document.getElementById('chromaTolerance').addEventListener('input', (e) => {
                document.getElementById('chromaToleranceValue').textContent = e.target.value;
            });
            document.getElementById('chromaFeather').addEventListener('input', (e) => {
                document.getElementById('chromaFeatherValue').textContent = e.target.value;
            });
            document.getElementById('pickColor').addEventListener('click', startPickColor);
            document.getElementById('applyChroma').addEventListener('click', applyChromaKey);

            // ÂèñËâ≤Ê®°Âºè
            mainCanvas.addEventListener('click', handleCanvasClick);

            // È°∂ÈÉ®ÊåâÈíÆ
            document.getElementById('undoBtn').addEventListener('click', undo);
            document.getElementById('redoBtn').addEventListener('click', redo);
            document.getElementById('resetBtn').addEventListener('click', reset);
            document.getElementById('downloadBtn').addEventListener('click', download);

            // Áº©Êîæ
            document.getElementById('zoomIn').addEventListener('click', () => setZoom(state.zoom + 0.1));
            document.getElementById('zoomOut').addEventListener('click', () => setZoom(state.zoom - 0.1));
            document.getElementById('zoomFit').addEventListener('click', fitToView);
        }

        // ========== Êñá‰ª∂Â§ÑÁêÜ ==========
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) loadImage(file);
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadBox.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) loadImage(file);
        }

        function loadImage(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    state.originalImage = img;
                    state.currentImage = img;
                    initCanvas(img);
                    uploadArea.classList.add('hidden');
                    mainCanvas.classList.remove('hidden');
                    bottomBar.style.display = 'flex';
                    enableButtons();
                    saveHistory('ÊâìÂºÄÂõæÁâá');
                    fitToView();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function initCanvas(img) {
            mainCanvas.width = img.width;
            mainCanvas.height = img.height;
            drawCanvas.width = img.width;
            drawCanvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            document.getElementById('imageDimensions').textContent = `${img.width} √ó ${img.height}`;
        }

        // ========== Â∑•ÂÖ∑ÂàáÊç¢ ==========
        function switchTool(tool) {
            state.currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tool === tool);
            });

            // ÂàáÊç¢Èù¢Êùø
            document.querySelectorAll('#panel > div').forEach(panel => panel.classList.add('hidden'));
            document.getElementById(`${tool}Panel`).classList.remove('hidden');

            // ÁªòÂõæÊ®°Âºè
            drawCanvas.classList.toggle('active', tool === 'draw');
            drawCanvas.classList.toggle('hidden', !state.originalImage);
        }

        // ========== Ë∞ÉËâ≤ÂíåÊª§Èïú ==========
        function applyAllEffects() {
            if (!state.originalImage) return;

            // ÂàõÂª∫‰∏¥Êó∂ÁîªÂ∏ÉÂ§ÑÁêÜÂèòÊç¢
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');

            let width = state.originalImage.width;
            let height = state.originalImage.height;

            // Â§ÑÁêÜ90Â∫¶ÊóãËΩ¨
            const rot = ((state.rotation % 360) + 360) % 360;
            if (rot === 90 || rot === 270) {
                tempCanvas.width = height;
                tempCanvas.height = width;
            } else {
                tempCanvas.width = width;
                tempCanvas.height = height;
            }

            tempCtx.save();
            tempCtx.translate(tempCanvas.width / 2, tempCanvas.height / 2);
            tempCtx.rotate(state.rotation * Math.PI / 180);
            tempCtx.scale(state.flipH ? -1 : 1, state.flipV ? -1 : 1);
            tempCtx.drawImage(state.originalImage, -width / 2, -height / 2);
            tempCtx.restore();

            // Ëé∑ÂèñÂÉèÁ¥†Êï∞ÊçÆ
            let imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);

            // Â∫îÁî®Ë∞ÉËâ≤
            applyAdjustments(imageData);

            // Â∫îÁî®Êª§Èïú
            const filter = filters.find(f => f.id === state.currentFilter);
            if (filter && filter.apply) {
                imageData = filter.apply(imageData, tempCanvas) || imageData;
            }

            // Êõ¥Êñ∞‰∏ªÁîªÂ∏É
            mainCanvas.width = tempCanvas.width;
            mainCanvas.height = tempCanvas.height;
            drawCanvas.width = tempCanvas.width;
            drawCanvas.height = tempCanvas.height;
            ctx.putImageData(imageData, 0, 0);

            document.getElementById('imageDimensions').textContent = `${mainCanvas.width} √ó ${mainCanvas.height}`;
        }

        function applyAdjustments(imageData) {
            const data = imageData.data;
            const { brightness, contrast, saturation, hue, exposure, noise } = state.adjustments;

            for (let i = 0; i < data.length; i += 4) {
                let r = data[i];
                let g = data[i + 1];
                let b = data[i + 2];

                // ‰∫ÆÂ∫¶
                r += brightness * 2.55;
                g += brightness * 2.55;
                b += brightness * 2.55;

                // ÊõùÂÖâ
                const expFactor = Math.pow(2, exposure / 50);
                r *= expFactor;
                g *= expFactor;
                b *= expFactor;

                // ÂØπÊØîÂ∫¶
                const contrastFactor = (259 * (contrast + 255)) / (255 * (259 - contrast));
                r = contrastFactor * (r - 128) + 128;
                g = contrastFactor * (g - 128) + 128;
                b = contrastFactor * (b - 128) + 128;

                // È•±ÂíåÂ∫¶ÂíåËâ≤Ë∞É
                if (saturation !== 0 || hue !== 0) {
                    let [h, s, l] = rgbToHsl(r, g, b);
                    s = Math.max(0, Math.min(1, s + saturation / 100));
                    h = (h + hue / 360 + 1) % 1;
                    [r, g, b] = hslToRgb(h, s, l);
                }

                // Âô™ÁÇπ
                if (noise > 0) {
                    const n = (Math.random() - 0.5) * noise * 2.55;
                    r += n;
                    g += n;
                    b += n;
                }

                data[i] = Math.max(0, Math.min(255, r));
                data[i + 1] = Math.max(0, Math.min(255, g));
                data[i + 2] = Math.max(0, Math.min(255, b));
            }
        }

        // ========== Êª§ÈïúÊïàÊûú ==========
        function applyGrayscale(imageData) {
            const data = imageData.data;
            for (let i = 0; i < data.length; i += 4) {
                const gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
                data[i] = data[i + 1] = data[i + 2] = gray;
            }
            return imageData;
        }

        function applyInvert(imageData) {
            const data = imageData.data;
            for (let i = 0; i < data.length; i += 4) {
                data[i] = 255 - data[i];
                data[i + 1] = 255 - data[i + 1];
                data[i + 2] = 255 - data[i + 2];
            }
            return imageData;
        }

        function applySepia(imageData) {
            const data = imageData.data;
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i], g = data[i + 1], b = data[i + 2];
                data[i] = Math.min(255, r * 0.393 + g * 0.769 + b * 0.189);
                data[i + 1] = Math.min(255, r * 0.349 + g * 0.686 + b * 0.168);
                data[i + 2] = Math.min(255, r * 0.272 + g * 0.534 + b * 0.131);
            }
            return imageData;
        }

        function applyVintage(imageData) {
            const data = imageData.data;
            for (let i = 0; i < data.length; i += 4) {
                data[i] = Math.min(255, data[i] * 1.1 + 20);
                data[i + 1] = Math.min(255, data[i + 1] * 0.9 + 10);
                data[i + 2] = Math.min(255, data[i + 2] * 0.8);
            }
            return imageData;
        }

        function applyCold(imageData) {
            const data = imageData.data;
            for (let i = 0; i < data.length; i += 4) {
                data[i] = Math.max(0, data[i] - 20);
                data[i + 2] = Math.min(255, data[i + 2] + 30);
            }
            return imageData;
        }

        function applyWarm(imageData) {
            const data = imageData.data;
            for (let i = 0; i < data.length; i += 4) {
                data[i] = Math.min(255, data[i] + 30);
                data[i + 2] = Math.max(0, data[i + 2] - 20);
            }
            return imageData;
        }

        function applyConvolution(imageData, canvas, kernel, divisor = 1) {
            const data = imageData.data;
            const w = canvas.width;
            const h = canvas.height;
            const output = new Uint8ClampedArray(data);
            const kSize = Math.sqrt(kernel.length);
            const half = Math.floor(kSize / 2);

            for (let y = half; y < h - half; y++) {
                for (let x = half; x < w - half; x++) {
                    let r = 0, g = 0, b = 0;
                    for (let ky = 0; ky < kSize; ky++) {
                        for (let kx = 0; kx < kSize; kx++) {
                            const idx = ((y + ky - half) * w + (x + kx - half)) * 4;
                            const k = kernel[ky * kSize + kx];
                            r += data[idx] * k;
                            g += data[idx + 1] * k;
                            b += data[idx + 2] * k;
                        }
                    }
                    const idx = (y * w + x) * 4;
                    output[idx] = Math.max(0, Math.min(255, r / divisor + 128));
                    output[idx + 1] = Math.max(0, Math.min(255, g / divisor + 128));
                    output[idx + 2] = Math.max(0, Math.min(255, b / divisor + 128));
                }
            }
            imageData.data.set(output);
            return imageData;
        }

        function applyBlur(imageData, canvas) {
            const kernel = [1, 2, 1, 2, 4, 2, 1, 2, 1];
            const data = imageData.data;
            const w = canvas.width;
            const h = canvas.height;
            const output = new Uint8ClampedArray(data);

            for (let y = 1; y < h - 1; y++) {
                for (let x = 1; x < w - 1; x++) {
                    let r = 0, g = 0, b = 0;
                    for (let ky = -1; ky <= 1; ky++) {
                        for (let kx = -1; kx <= 1; kx++) {
                            const idx = ((y + ky) * w + (x + kx)) * 4;
                            const k = kernel[(ky + 1) * 3 + (kx + 1)];
                            r += data[idx] * k;
                            g += data[idx + 1] * k;
                            b += data[idx + 2] * k;
                        }
                    }
                    const idx = (y * w + x) * 4;
                    output[idx] = r / 16;
                    output[idx + 1] = g / 16;
                    output[idx + 2] = b / 16;
                }
            }
            imageData.data.set(output);
            return imageData;
        }

        function applySharpen(imageData, canvas) {
            const kernel = [0, -1, 0, -1, 5, -1, 0, -1, 0];
            const data = imageData.data;
            const w = canvas.width;
            const h = canvas.height;
            const output = new Uint8ClampedArray(data);

            for (let y = 1; y < h - 1; y++) {
                for (let x = 1; x < w - 1; x++) {
                    let r = 0, g = 0, b = 0;
                    for (let ky = -1; ky <= 1; ky++) {
                        for (let kx = -1; kx <= 1; kx++) {
                            const idx = ((y + ky) * w + (x + kx)) * 4;
                            const k = kernel[(ky + 1) * 3 + (kx + 1)];
                            r += data[idx] * k;
                            g += data[idx + 1] * k;
                            b += data[idx + 2] * k;
                        }
                    }
                    const idx = (y * w + x) * 4;
                    output[idx] = Math.max(0, Math.min(255, r));
                    output[idx + 1] = Math.max(0, Math.min(255, g));
                    output[idx + 2] = Math.max(0, Math.min(255, b));
                }
            }
            imageData.data.set(output);
            return imageData;
        }

        function applyEmboss(imageData, canvas) {
            const kernel = [-2, -1, 0, -1, 1, 1, 0, 1, 2];
            return applyConvolution(imageData, canvas, kernel, 1);
        }

        function applyEdge(imageData, canvas) {
            const kernel = [-1, -1, -1, -1, 8, -1, -1, -1, -1];
            const data = imageData.data;
            const w = canvas.width;
            const h = canvas.height;
            const output = new Uint8ClampedArray(data);

            for (let y = 1; y < h - 1; y++) {
                for (let x = 1; x < w - 1; x++) {
                    let r = 0, g = 0, b = 0;
                    for (let ky = -1; ky <= 1; ky++) {
                        for (let kx = -1; kx <= 1; kx++) {
                            const idx = ((y + ky) * w + (x + kx)) * 4;
                            const k = kernel[(ky + 1) * 3 + (kx + 1)];
                            r += data[idx] * k;
                            g += data[idx + 1] * k;
                            b += data[idx + 2] * k;
                        }
                    }
                    const idx = (y * w + x) * 4;
                    const val = Math.abs(r) + Math.abs(g) + Math.abs(b);
                    output[idx] = output[idx + 1] = output[idx + 2] = Math.min(255, val);
                }
            }
            imageData.data.set(output);
            return imageData;
        }

        function applyPixelate(imageData, canvas) {
            const data = imageData.data;
            const w = canvas.width;
            const h = canvas.height;
            const size = Math.max(4, Math.floor(Math.min(w, h) / 50));

            for (let y = 0; y < h; y += size) {
                for (let x = 0; x < w; x += size) {
                    const idx = (y * w + x) * 4;
                    const r = data[idx], g = data[idx + 1], b = data[idx + 2];

                    for (let dy = 0; dy < size && y + dy < h; dy++) {
                        for (let dx = 0; dx < size && x + dx < w; dx++) {
                            const i = ((y + dy) * w + (x + dx)) * 4;
                            data[i] = r;
                            data[i + 1] = g;
                            data[i + 2] = b;
                        }
                    }
                }
            }
            return imageData;
        }

        // ========== Êª§ÈïúÈÄâÊã©Âô® ==========
        function generateFilterGrid() {
            const grid = document.getElementById('filterGrid');
            grid.innerHTML = filters.map(f => `
                <div class="filter-item ${f.id === 'none' ? 'active' : ''}" data-filter="${f.id}">
                    <div class="filter-preview">
                        <div style="width:100%;height:100%;background:linear-gradient(135deg,#667eea,#764ba2);"></div>
                    </div>
                    <div class="filter-name">${f.name}</div>
                </div>
            `).join('');

            grid.querySelectorAll('.filter-item').forEach(item => {
                item.addEventListener('click', () => {
                    grid.querySelectorAll('.filter-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    state.currentFilter = item.dataset.filter;
                    applyAllEffects();
                    saveHistory(`Êª§Èïú: ${filters.find(f => f.id === state.currentFilter).name}`);
                });
            });
        }

        // ========== ÂèòÊç¢ ==========
        function rotate(deg) {
            state.rotation = (state.rotation + deg + 360) % 360;
            document.getElementById('rotateSlider').value = state.rotation;
            document.getElementById('rotateValue').textContent = state.rotation + '¬∞';
            applyAllEffects();
            saveHistory(`ÊóãËΩ¨ ${deg}¬∞`);
        }

        // ========== Ë£ÅÂàá ==========
        function startCrop() {
            if (!state.originalImage) return;

            const overlay = document.getElementById('cropOverlay');
            const cropImage = document.getElementById('cropImage');

            cropImage.src = mainCanvas.toDataURL();
            overlay.classList.add('active');

            if (state.cropper) state.cropper.destroy();

            state.cropper = new Cropper(cropImage, {
                viewMode: 1,
                dragMode: 'move',
                autoCropArea: 0.8,
                responsive: true,
                background: false
            });
        }

        function setCropRatio(ratio) {
            document.querySelectorAll('.ratio-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');

            if (state.cropper) {
                state.cropper.setAspectRatio(ratio === 'free' ? NaN : parseFloat(ratio));
            }
        }

        function applyCrop() {
            if (!state.cropper) return;

            const croppedCanvas = state.cropper.getCroppedCanvas();
            const img = new Image();
            img.onload = () => {
                state.originalImage = img;
                initCanvas(img);
                applyAllEffects();
                saveHistory('Ë£ÅÂàá');
                cancelCrop();
            };
            img.src = croppedCanvas.toDataURL();
        }

        function cancelCrop() {
            if (state.cropper) {
                state.cropper.destroy();
                state.cropper = null;
            }
            document.getElementById('cropOverlay').classList.remove('active');
        }

        // ========== Ê†áÊ≥®ÁªòÂõæ ==========
        let drawStart = { x: 0, y: 0 };

        function startDrawing(e) {
            if (state.currentTool !== 'draw') return;
            state.isDrawing = true;

            const rect = drawCanvas.getBoundingClientRect();
            const scaleX = drawCanvas.width / rect.width;
            const scaleY = drawCanvas.height / rect.height;
            drawStart.x = (e.clientX - rect.left) * scaleX;
            drawStart.y = (e.clientY - rect.top) * scaleY;

            if (state.drawTool === 'brush' || state.drawTool === 'eraser') {
                drawCtx.beginPath();
                drawCtx.moveTo(drawStart.x, drawStart.y);
            }
        }

        function draw(e) {
            if (!state.isDrawing) return;

            const rect = drawCanvas.getBoundingClientRect();
            const scaleX = drawCanvas.width / rect.width;
            const scaleY = drawCanvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;

            drawCtx.lineWidth = state.brushSize;
            drawCtx.lineCap = 'round';
            drawCtx.lineJoin = 'round';

            if (state.drawTool === 'brush') {
                drawCtx.strokeStyle = state.drawColor;
                drawCtx.globalCompositeOperation = 'source-over';
                drawCtx.lineTo(x, y);
                drawCtx.stroke();
            } else if (state.drawTool === 'eraser') {
                drawCtx.globalCompositeOperation = 'destination-out';
                drawCtx.lineTo(x, y);
                drawCtx.stroke();
            }
        }

        function stopDrawing(e) {
            if (!state.isDrawing) return;
            state.isDrawing = false;

            if (['line', 'rect', 'circle', 'arrow'].includes(state.drawTool)) {
                const rect = drawCanvas.getBoundingClientRect();
                const scaleX = drawCanvas.width / rect.width;
                const scaleY = drawCanvas.height / rect.height;
                const x = (e.clientX - rect.left) * scaleX;
                const y = (e.clientY - rect.top) * scaleY;

                drawCtx.strokeStyle = state.drawColor;
                drawCtx.lineWidth = state.brushSize;
                drawCtx.globalCompositeOperation = 'source-over';

                if (state.drawTool === 'line') {
                    drawCtx.beginPath();
                    drawCtx.moveTo(drawStart.x, drawStart.y);
                    drawCtx.lineTo(x, y);
                    drawCtx.stroke();
                } else if (state.drawTool === 'rect') {
                    drawCtx.strokeRect(drawStart.x, drawStart.y, x - drawStart.x, y - drawStart.y);
                } else if (state.drawTool === 'circle') {
                    const rx = Math.abs(x - drawStart.x) / 2;
                    const ry = Math.abs(y - drawStart.y) / 2;
                    const cx = drawStart.x + (x - drawStart.x) / 2;
                    const cy = drawStart.y + (y - drawStart.y) / 2;
                    drawCtx.beginPath();
                    drawCtx.ellipse(cx, cy, rx, ry, 0, 0, Math.PI * 2);
                    drawCtx.stroke();
                } else if (state.drawTool === 'arrow') {
                    drawArrow(drawStart.x, drawStart.y, x, y);
                }
            }

            drawCtx.beginPath();
        }

        function drawArrow(fromX, fromY, toX, toY) {
            const headLen = state.brushSize * 3;
            const angle = Math.atan2(toY - fromY, toX - fromX);

            drawCtx.beginPath();
            drawCtx.moveTo(fromX, fromY);
            drawCtx.lineTo(toX, toY);
            drawCtx.stroke();

            drawCtx.beginPath();
            drawCtx.moveTo(toX, toY);
            drawCtx.lineTo(toX - headLen * Math.cos(angle - Math.PI / 6), toY - headLen * Math.sin(angle - Math.PI / 6));
            drawCtx.lineTo(toX - headLen * Math.cos(angle + Math.PI / 6), toY - headLen * Math.sin(angle + Math.PI / 6));
            drawCtx.closePath();
            drawCtx.fillStyle = state.drawColor;
            drawCtx.fill();
        }

        function clearDrawCanvas() {
            drawCtx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);
        }

        // ========== ÊñáÂ≠ó ==========
        const textLayerContainer = document.getElementById('textLayerContainer');
        let textLayerId = 0;

        function addTextLayer() {
            const text = document.getElementById('textInput').value.trim();
            if (!text || !state.originalImage) return;

            const color = document.getElementById('textColor').value;
            const size = document.getElementById('fontSize').value;
            const font = document.getElementById('fontFamily').value;
            const bold = document.getElementById('textBold').checked;
            const shadow = document.getElementById('textShadow').checked;

            // ÂàõÂª∫ÊñáÂ≠óÂõæÂ±Ç DOM ÂÖÉÁ¥†
            const layer = document.createElement('div');
            layer.className = 'text-layer';
            layer.id = `text-layer-${textLayerId++}`;
            layer.textContent = text;
            layer.style.cssText = `
                position: absolute;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
                color: ${color};
                font-size: ${size}px;
                font-family: ${font};
                font-weight: ${bold ? 'bold' : 'normal'};
                ${shadow ? 'text-shadow: 2px 2px 4px rgba(0,0,0,0.5);' : ''}
            `;

            // Âà†Èô§ÊåâÈíÆ
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.textContent = '√ó';
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                layer.remove();
                state.textLayers = state.textLayers.filter(l => l.id !== layer.id);
            };
            layer.appendChild(deleteBtn);

            // ‰øùÂ≠òÂà∞Áä∂ÊÄÅ
            const layerData = {
                id: layer.id,
                text, color, size: parseInt(size), font, bold, shadow,
                x: 0.5, y: 0.5  // Áõ∏ÂØπ‰ΩçÁΩÆÔºà0-1Ôºâ
            };
            state.textLayers.push(layerData);

            // ÊãñÂä®ÂäüËÉΩ
            let isDragging = false;
            let startX, startY, startLeft, startTop;

            layer.addEventListener('mousedown', (e) => {
                if (e.target === deleteBtn) return;
                isDragging = true;
                layer.classList.add('selected');
                startX = e.clientX;
                startY = e.clientY;
                const rect = layer.getBoundingClientRect();
                const containerRect = textLayerContainer.getBoundingClientRect();
                startLeft = rect.left - containerRect.left + rect.width / 2;
                startTop = rect.top - containerRect.top + rect.height / 2;
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const containerRect = textLayerContainer.getBoundingClientRect();
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                const newLeft = startLeft + dx;
                const newTop = startTop + dy;

                layer.style.left = newLeft + 'px';
                layer.style.top = newTop + 'px';
                layer.style.transform = 'translate(-50%, -50%)';

                // Êõ¥Êñ∞Áõ∏ÂØπ‰ΩçÁΩÆ
                layerData.x = newLeft / containerRect.width;
                layerData.y = newTop / containerRect.height;
            });

            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    layer.classList.remove('selected');
                }
            });

            textLayerContainer.appendChild(layer);
            document.getElementById('textInput').value = '';
        }

        // Â∞ÜÊñáÂ≠óÂõæÂ±ÇÁªòÂà∂Âà∞ÁîªÂ∏ÉÔºà‰øùÂ≠òÊó∂Ë∞ÉÁî®Ôºâ
        function renderTextLayersToCanvas() {
            const containerRect = textLayerContainer.getBoundingClientRect();
            const canvasRect = mainCanvas.getBoundingClientRect();
            const scaleX = mainCanvas.width / canvasRect.width;
            const scaleY = mainCanvas.height / canvasRect.height;

            state.textLayers.forEach(layerData => {
                const layer = document.getElementById(layerData.id);
                if (!layer) return;

                const rect = layer.getBoundingClientRect();
                const x = (rect.left - canvasRect.left + rect.width / 2) * scaleX;
                const y = (rect.top - canvasRect.top + rect.height / 2) * scaleY;

                ctx.font = `${layerData.bold ? 'bold ' : ''}${layerData.size * scaleX}px ${layerData.font}`;
                ctx.fillStyle = layerData.color;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';

                if (layerData.shadow) {
                    ctx.shadowColor = 'rgba(0,0,0,0.5)';
                    ctx.shadowBlur = 4 * scaleX;
                    ctx.shadowOffsetX = 2 * scaleX;
                    ctx.shadowOffsetY = 2 * scaleY;
                }

                ctx.fillText(layerData.text, x, y);

                ctx.shadowColor = 'transparent';
                ctx.shadowBlur = 0;
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 0;
            });
        }

        // Ê∏ÖÈô§ÊñáÂ≠óÂõæÂ±Ç
        function clearTextLayers() {
            textLayerContainer.innerHTML = '';
            state.textLayers = [];
        }

        // ========== Êä†Âõæ ==========
        function startPickColor() {
            state.isPickingColor = true;
            mainCanvas.style.cursor = 'crosshair';
            alert('ËØ∑ÁÇπÂáªÂõæÁâá‰∏äË¶ÅÂéªÈô§ÁöÑËÉåÊôØÈ¢úËâ≤');
        }

        function handleCanvasClick(e) {
            if (!state.isPickingColor) return;

            const rect = mainCanvas.getBoundingClientRect();
            const scaleX = mainCanvas.width / rect.width;
            const scaleY = mainCanvas.height / rect.height;
            const x = Math.floor((e.clientX - rect.left) * scaleX);
            const y = Math.floor((e.clientY - rect.top) * scaleY);

            const pixel = ctx.getImageData(x, y, 1, 1).data;
            const hex = '#' + [pixel[0], pixel[1], pixel[2]].map(v => v.toString(16).padStart(2, '0')).join('');

            document.getElementById('chromaColor').value = hex;
            state.isPickingColor = false;
            mainCanvas.style.cursor = 'default';
        }

        function applyChromaKey() {
            if (!state.originalImage) return;

            const color = document.getElementById('chromaColor').value;
            const tolerance = parseInt(document.getElementById('chromaTolerance').value);
            const feather = parseInt(document.getElementById('chromaFeather').value);

            const targetR = parseInt(color.slice(1, 3), 16);
            const targetG = parseInt(color.slice(3, 5), 16);
            const targetB = parseInt(color.slice(5, 7), 16);

            const imageData = ctx.getImageData(0, 0, mainCanvas.width, mainCanvas.height);
            const data = imageData.data;

            for (let i = 0; i < data.length; i += 4) {
                const r = data[i], g = data[i + 1], b = data[i + 2];
                const diff = Math.sqrt(
                    Math.pow(r - targetR, 2) +
                    Math.pow(g - targetG, 2) +
                    Math.pow(b - targetB, 2)
                );

                if (diff < tolerance * 4.4) {
                    if (feather > 0 && diff > (tolerance - feather) * 4.4) {
                        data[i + 3] = Math.floor(255 * (diff - (tolerance - feather) * 4.4) / (feather * 4.4));
                    } else {
                        data[i + 3] = 0;
                    }
                }
            }

            ctx.putImageData(imageData, 0, 0);
            saveHistory('Êä†Âõæ');
        }

        // ========== ÂéÜÂè≤ËÆ∞ÂΩï ==========
        function saveHistory(action) {
            // ÂêàÂπ∂Ê†áÊ≥®ÂõæÂ±Ç
            const combined = document.createElement('canvas');
            combined.width = mainCanvas.width;
            combined.height = mainCanvas.height;
            const combCtx = combined.getContext('2d');
            combCtx.drawImage(mainCanvas, 0, 0);
            combCtx.drawImage(drawCanvas, 0, 0);

            state.history = state.history.slice(0, state.historyIndex + 1);
            state.history.push({
                action,
                data: combined.toDataURL(),
                adjustments: { ...state.adjustments },
                filter: state.currentFilter,
                rotation: state.rotation,
                flipH: state.flipH,
                flipV: state.flipV
            });
            state.historyIndex = state.history.length - 1;

            updateHistoryButtons();
        }

        function undo() {
            if (state.historyIndex > 0) {
                state.historyIndex--;
                restoreHistory();
            }
        }

        function redo() {
            if (state.historyIndex < state.history.length - 1) {
                state.historyIndex++;
                restoreHistory();
            }
        }

        function restoreHistory() {
            const entry = state.history[state.historyIndex];
            const img = new Image();
            img.onload = () => {
                mainCanvas.width = img.width;
                mainCanvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                drawCanvas.width = img.width;
                drawCanvas.height = img.height;
                drawCtx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);

                // ÊÅ¢Â§çÁä∂ÊÄÅ
                state.adjustments = { ...entry.adjustments };
                state.currentFilter = entry.filter;
                state.rotation = entry.rotation;
                state.flipH = entry.flipH;
                state.flipV = entry.flipV;

                // Êõ¥Êñ∞UI
                Object.keys(state.adjustments).forEach(key => {
                    const slider = document.getElementById(key);
                    if (slider) {
                        slider.value = state.adjustments[key];
                        document.getElementById(`${key}Value`).textContent = state.adjustments[key];
                    }
                });
                document.getElementById('rotateSlider').value = state.rotation;
                document.getElementById('rotateValue').textContent = state.rotation + '¬∞';
            };
            img.src = entry.data;
            updateHistoryButtons();
        }

        function updateHistoryButtons() {
            document.getElementById('undoBtn').disabled = state.historyIndex <= 0;
            document.getElementById('redoBtn').disabled = state.historyIndex >= state.history.length - 1;
        }

        function reset() {
            if (!state.originalImage || !confirm('Á°ÆÂÆöË¶ÅÈáçÁΩÆÊâÄÊúâ‰øÆÊîπÂêóÔºü')) return;

            state.adjustments = { brightness: 0, contrast: 0, saturation: 0, hue: 0, exposure: 0, noise: 0 };
            state.currentFilter = 'none';
            state.rotation = 0;
            state.flipH = false;
            state.flipV = false;

            // ÈáçÁΩÆUI
            Object.keys(state.adjustments).forEach(key => {
                const slider = document.getElementById(key);
                if (slider) {
                    slider.value = 0;
                    document.getElementById(`${key}Value`).textContent = '0';
                }
            });
            document.getElementById('rotateSlider').value = 0;
            document.getElementById('rotateValue').textContent = '0¬∞';
            document.querySelectorAll('.filter-item').forEach(i => i.classList.remove('active'));
            document.querySelector('.filter-item[data-filter="none"]').classList.add('active');

            clearDrawCanvas();
            clearTextLayers();
            initCanvas(state.originalImage);
            saveHistory('ÈáçÁΩÆ');
        }

        // ========== Áº©Êîæ ==========
        function setZoom(z) {
            state.zoom = Math.max(0.1, Math.min(3, z));
            mainCanvas.style.transform = `scale(${state.zoom})`;
            drawCanvas.style.transform = `scale(${state.zoom})`;
            textLayerContainer.style.transform = `scale(${state.zoom})`;
            document.getElementById('zoomValue').textContent = Math.round(state.zoom * 100) + '%';
        }

        function fitToView() {
            const wrapper = canvasWrapper.getBoundingClientRect();
            const scaleX = (wrapper.width - 40) / mainCanvas.width;
            const scaleY = (wrapper.height - 40) / mainCanvas.height;
            setZoom(Math.min(scaleX, scaleY, 1));
        }

        // ========== ‰∏ãËΩΩ ==========
        function download() {
            // ÂêàÂπ∂ÊâÄÊúâÂõæÂ±Ç
            const combined = document.createElement('canvas');
            combined.width = mainCanvas.width;
            combined.height = mainCanvas.height;
            const combCtx = combined.getContext('2d');
            combCtx.drawImage(mainCanvas, 0, 0);
            combCtx.drawImage(drawCanvas, 0, 0);

            // ÁªòÂà∂ÊñáÂ≠óÂõæÂ±Ç
            const canvasRect = mainCanvas.getBoundingClientRect();
            const scaleX = mainCanvas.width / canvasRect.width;
            const scaleY = mainCanvas.height / canvasRect.height;

            state.textLayers.forEach(layerData => {
                const layer = document.getElementById(layerData.id);
                if (!layer) return;

                const rect = layer.getBoundingClientRect();
                const x = (rect.left - canvasRect.left + rect.width / 2) * scaleX;
                const y = (rect.top - canvasRect.top + rect.height / 2) * scaleY;

                combCtx.font = `${layerData.bold ? 'bold ' : ''}${layerData.size * scaleX}px ${layerData.font}`;
                combCtx.fillStyle = layerData.color;
                combCtx.textAlign = 'center';
                combCtx.textBaseline = 'middle';

                if (layerData.shadow) {
                    combCtx.shadowColor = 'rgba(0,0,0,0.5)';
                    combCtx.shadowBlur = 4 * scaleX;
                    combCtx.shadowOffsetX = 2 * scaleX;
                    combCtx.shadowOffsetY = 2 * scaleY;
                }

                combCtx.fillText(layerData.text, x, y);

                combCtx.shadowColor = 'transparent';
                combCtx.shadowBlur = 0;
                combCtx.shadowOffsetX = 0;
                combCtx.shadowOffsetY = 0;
            });

            const link = document.createElement('a');
            link.download = 'edited-image.png';
            link.href = combined.toDataURL('image/png');
            link.click();
        }

        function enableButtons() {
            document.getElementById('resetBtn').disabled = false;
            document.getElementById('downloadBtn').disabled = false;
        }

        // ========== Â∑•ÂÖ∑ÂáΩÊï∞ ==========
        function rgbToHsl(r, g, b) {
            r /= 255; g /= 255; b /= 255;
            const max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;

            if (max === min) {
                h = s = 0;
            } else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
                    case g: h = ((b - r) / d + 2) / 6; break;
                    case b: h = ((r - g) / d + 4) / 6; break;
                }
            }
            return [h, s, l];
        }

        function hslToRgb(h, s, l) {
            let r, g, b;
            if (s === 0) {
                r = g = b = l;
            } else {
                const hue2rgb = (p, q, t) => {
                    if (t < 0) t += 1;
                    if (t > 1) t -= 1;
                    if (t < 1 / 6) return p + (q - p) * 6 * t;
                    if (t < 1 / 2) return q;
                    if (t < 2 / 3) return p + (q - p) * (2 / 3 - t) * 6;
                    return p;
                };
                const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                const p = 2 * l - q;
                r = hue2rgb(p, q, h + 1 / 3);
                g = hue2rgb(p, q, h);
                b = hue2rgb(p, q, h - 1 / 3);
            }
            return [r * 255, g * 255, b * 255];
        }

        // ÂêØÂä®
        init();

        // ========== Â§öËØ≠Ë®ÄÊîØÊåÅ ==========
        const i18n = {
            en: {
                title: "Online Image Editor",
                backToToolbox: "‚Üê Back to Toolbox",
                openImage: "üìÇ Open Image",
                undo: "‚Ü© Undo",
                redo: "‚Ü™ Redo",
                reset: "üîÑ Reset",
                saveImage: "üíæ Save Image",
                featureBasicTitle: "100% Free & Private",
                featureBasicDesc: "No ads, no signup, no watermark. Everything runs locally in your browser. Your data never leaves your device.",
                featureFilterTitle: "Filter Effects",
                featureFilterDesc: "Brightness, contrast, saturation, blur and more filters",
                featureTextTitle: "Text Watermark",
                featureTextDesc: "Add custom text watermarks with adjustable font and position",
                featurePreviewTitle: "Live Preview",
                featurePreviewDesc: "All adjustments preview instantly, what you see is what you get",
                toolAdjust: "Adjust",
                toolFilter: "Filter",
                toolCrop: "Crop",
                toolTransform: "Transform",
                toolDraw: "Draw",
                toolText: "Text",
                toolChroma: "Chroma",
                uploadTitle: "Drag image here",
                uploadDesc: "Or click to select image file (supports JPG, PNG, WebP, GIF)",
                ratioFree: "Free",
                applyCrop: "‚úì Apply Crop",
                cancel: "‚úï Cancel",
                panelAdjust: "üé® Adjust",
                brightness: "Brightness",
                contrast: "Contrast",
                saturation: "Saturation",
                hue: "Hue",
                exposure: "Exposure",
                noise: "Noise",
                panelFilter: "‚ú® Filter",
                panelCrop: "‚úÇÔ∏è Crop",
                cropHint: "Click the button below to enter crop mode, drag to adjust crop area",
                startCrop: "Start Crop",
                panelTransform: "üîÑ Transform",
                flip: "Flip",
                flipHorizontal: "Flip H",
                flipVertical: "Flip V",
                rotate: "Rotate",
                rotateLeft: "Left 90¬∞",
                rotateRight: "Right 90¬∞",
                freeRotate: "Free Rotate",
                panelDraw: "‚úèÔ∏è Draw",
                tools: "Tools",
                brush: "Brush",
                line: "Line",
                rectangle: "Rect",
                circle: "Circle",
                arrow: "Arrow",
                eraser: "Eraser",
                brushColor: "Brush Color",
                brushSize: "Brush Size",
                clearDraw: "Clear Drawing",
                panelText: "üìù Text",
                textPlaceholder: "Enter text content...",
                textColor: "Text Color",
                fontSize: "Font Size",
                bold: "Bold",
                shadow: "Shadow",
                addText: "Add Text",
                textHint: "Drag text to adjust position after adding",
                clearAllText: "Clear All Text",
                panelChroma: "üé≠ Chroma Key",
                chromaHint: "Select background color to remove, adjust tolerance for natural effect",
                selectBgColor: "Select BG Color",
                pickFromImage: "üéØ Pick from Image",
                tolerance: "Tolerance",
                feather: "Edge Feather",
                applyChroma: "Apply Chroma",
                faqTitle: "FAQ",
                faq1q: "What image formats are supported?",
                faq1a: "Supports JPG, PNG, WebP, GIF, BMP and other common image formats.",
                faq2q: "Can I undo edits?",
                faq2a: "Yes, undo and redo functions are supported.",
                faq3q: "What format is the edited image?",
                faq3a: "You can choose to export as JPG, PNG, or WebP format.",
                faq4q: "Can I batch edit images?",
                faq4a: "Not currently supported, only one image can be edited at a time.",
                faq5q: "Are images uploaded to a server?",
                faq5a: "No, all editing is done locally in your browser.",
                relatedTools: "Related Tools",
                toolCompressor: "Image Compressor",
                toolCompressorDesc: "Compress image size online",
                toolConverter: "Image Converter",
                toolConverterDesc: "PNG/JPG/WebP conversion",
                toolIdPhoto: "ID Photo Maker",
                toolIdPhotoDesc: "Change ID photo background",
                toolPalette: "Color Palette",
                toolPaletteDesc: "Color selection and conversion",
                footerText: "Pure frontend processing, data is not uploaded to server",
                backToHome: "Back to Web Toolbox",
                filterNone: "Original",
                filterGrayscale: "Grayscale",
                filterInvert: "Invert",
                filterSepia: "Sepia",
                filterVintage: "Vintage",
                filterCold: "Cold",
                filterWarm: "Warm",
                filterBlur: "Blur",
                filterSharpen: "Sharpen",
                filterEmboss: "Emboss",
                filterPixelate: "Pixelate",
                filterEdge: "Edge",
                faq_free_q: "Is this tool really free with no ads?",
                faq_free_a: "Yes, 100% free with no ads, no registration, no watermark, and no usage limits. All processing happens locally in your browser ‚Äî your data is never uploaded to any server.",
                trust_users: "üåç Used by 50,000+ users",
                trust_rating: "‚≠ê 4.9/5 rating",
                trust_privacy: "üîí 100% Private",
                trust_free: "üö´ No Ads, No Signup"
            },
            "zh-CN": {
                title: "Âú®Á∫øÂõæÁâáÁºñËæëÂô®",
                backToToolbox: "‚Üê ËøîÂõûÂ∑•ÂÖ∑ÁÆ±",
                openImage: "üìÇ ÊâìÂºÄÂõæÁâá",
                undo: "‚Ü© Êí§ÈîÄ",
                redo: "‚Ü™ ÈáçÂÅö",
                reset: "üîÑ ÈáçÁΩÆ",
                saveImage: "üíæ ‰øùÂ≠òÂõæÁâá",
                featureBasicTitle: "100% ÂÖçË¥π‰∏îÂÆâÂÖ®",
                featureBasicDesc: "Êó†ÂπøÂëä„ÄÅÊó†ÈúÄÊ≥®ÂÜå„ÄÅÊó†Ê∞¥Âç∞„ÄÇÊâÄÊúâÂ§ÑÁêÜÈÉΩÂú®ÊµèËßàÂô®Êú¨Âú∞ÂÆåÊàêÔºåÊï∞ÊçÆ‰∏ç‰ºö‰∏ä‰º†Âà∞‰ªª‰ΩïÊúçÂä°Âô®„ÄÇ",
                featureFilterTitle: "Êª§ÈïúÊïàÊûú",
                featureFilterDesc: "Êèê‰æõ‰∫ÆÂ∫¶„ÄÅÂØπÊØîÂ∫¶„ÄÅÈ•±ÂíåÂ∫¶„ÄÅÊ®°Á≥äÁ≠âÊª§ÈïúË∞ÉËäÇ",
                featureTextTitle: "ÊñáÂ≠óÊ∞¥Âç∞",
                featureTextDesc: "ÂèØÊ∑ªÂä†Ëá™ÂÆö‰πâÊñáÂ≠óÊ∞¥Âç∞ÔºåÊîØÊåÅË∞ÉÊï¥Â≠ó‰ΩìÂíå‰ΩçÁΩÆ",
                featurePreviewTitle: "ÂÆûÊó∂È¢ÑËßà",
                featurePreviewDesc: "ÊâÄÊúâË∞ÉÊï¥Âç≥Êó∂È¢ÑËßàÔºåÊâÄËßÅÂç≥ÊâÄÂæó",
                toolAdjust: "Ë∞ÉËâ≤",
                toolFilter: "Êª§Èïú",
                toolCrop: "Ë£ÅÂàá",
                toolTransform: "ÂèòÊç¢",
                toolDraw: "Ê†áÊ≥®",
                toolText: "ÊñáÂ≠ó",
                toolChroma: "Êä†Âõæ",
                uploadTitle: "ÊãñÊãΩÂõæÁâáÂà∞Ê≠§Â§Ñ",
                uploadDesc: "ÊàñÁÇπÂáªÈÄâÊã©ÂõæÁâáÊñá‰ª∂ÔºàÊîØÊåÅ JPG„ÄÅPNG„ÄÅWebP„ÄÅGIFÔºâ",
                ratioFree: "Ëá™Áî±",
                applyCrop: "‚úì Â∫îÁî®Ë£ÅÂàá",
                cancel: "‚úï ÂèñÊ∂à",
                panelAdjust: "üé® Ë∞ÉËâ≤",
                brightness: "‰∫ÆÂ∫¶",
                contrast: "ÂØπÊØîÂ∫¶",
                saturation: "È•±ÂíåÂ∫¶",
                hue: "Ëâ≤Ë∞É",
                exposure: "ÊõùÂÖâ",
                noise: "Âô™ÁÇπ",
                panelFilter: "‚ú® Êª§Èïú",
                panelCrop: "‚úÇÔ∏è Ë£ÅÂàá",
                cropHint: "ÁÇπÂáª‰∏ãÊñπÊåâÈíÆËøõÂÖ•Ë£ÅÂàáÊ®°ÂºèÔºåÊãñÊãΩË∞ÉÊï¥Ë£ÅÂàáÂå∫Âüü",
                startCrop: "ÂºÄÂßãË£ÅÂàá",
                panelTransform: "üîÑ ÂèòÊç¢",
                flip: "ÁøªËΩ¨",
                flipHorizontal: "Ê∞¥Âπ≥ÁøªËΩ¨",
                flipVertical: "ÂûÇÁõ¥ÁøªËΩ¨",
                rotate: "ÊóãËΩ¨",
                rotateLeft: "Â∑¶Êóã90¬∞",
                rotateRight: "Âè≥Êóã90¬∞",
                freeRotate: "Ëá™Áî±ÊóãËΩ¨",
                panelDraw: "‚úèÔ∏è Ê†áÊ≥®",
                tools: "Â∑•ÂÖ∑",
                brush: "ÁîªÁ¨î",
                line: "Áõ¥Á∫ø",
                rectangle: "Áü©ÂΩ¢",
                circle: "ÂúÜÂΩ¢",
                arrow: "ÁÆ≠Â§¥",
                eraser: "Ê©°ÁöÆ",
                brushColor: "ÁîªÁ¨îÈ¢úËâ≤",
                brushSize: "ÁîªÁ¨îÂ§ßÂ∞è",
                clearDraw: "Ê∏ÖÈô§Ê†áÊ≥®",
                panelText: "üìù ÊñáÂ≠ó",
                textPlaceholder: "ËæìÂÖ•ÊñáÂ≠óÂÜÖÂÆπ...",
                textColor: "ÊñáÂ≠óÈ¢úËâ≤",
                fontSize: "Â≠ó‰ΩìÂ§ßÂ∞è",
                bold: "Á≤ó‰Ωì",
                shadow: "Èò¥ÂΩ±",
                addText: "Ê∑ªÂä†ÊñáÂ≠ó",
                textHint: "üí° Ê∑ªÂä†ÂêéÂèØÊãñÂä®ÊñáÂ≠óË∞ÉÊï¥‰ΩçÁΩÆ",
                clearAllText: "Ê∏ÖÈô§ÊâÄÊúâÊñáÂ≠ó",
                panelChroma: "üé≠ Á∫ØËâ≤Êä†Âõæ",
                chromaHint: "ÈÄâÊã©Ë¶ÅÂéªÈô§ÁöÑËÉåÊôØÈ¢úËâ≤ÔºåË∞ÉÊï¥ÂÆπÂ∑ÆÂÄº‰ΩøÊä†ÂõæÊïàÊûúÊõ¥Ëá™ÁÑ∂",
                selectBgColor: "ÈÄâÊã©ËÉåÊôØËâ≤",
                pickFromImage: "üéØ ‰ªéÂõæÁâáÂèñËâ≤",
                tolerance: "ÂÆπÂ∑Æ",
                feather: "ËæπÁºòÁæΩÂåñ",
                applyChroma: "Â∫îÁî®Êä†Âõæ",
                faqTitle: "Â∏∏ËßÅÈóÆÈ¢ò",
                faq1q: "ÊîØÊåÅÁºñËæëÂì™‰∫õÊ†ºÂºèÁöÑÂõæÁâáÔºü",
                faq1a: "ÊîØÊåÅ JPG„ÄÅPNG„ÄÅWebP„ÄÅGIF„ÄÅBMP Á≠âÂ∏∏ËßÅÂõæÁâáÊ†ºÂºè„ÄÇ",
                faq2q: "ÂèØ‰ª•Êí§ÈîÄÁºñËæëÊìç‰ΩúÂêóÔºü",
                faq2a: "ÂèØ‰ª•ÔºåÊîØÊåÅÊí§ÈîÄÂíåÈáçÂÅöÂäüËÉΩ„ÄÇ",
                faq3q: "ÁºñËæëÂêéÁöÑÂõæÁâáÊ†ºÂºèÊòØ‰ªÄ‰πàÔºü",
                faq3a: "ÂèØÈÄâÊã©ÂØºÂá∫‰∏∫ JPG„ÄÅPNG Êàñ WebP Ê†ºÂºè„ÄÇ",
                faq4q: "ÂèØ‰ª•ÊâπÈáèÁºñËæëÂõæÁâáÂêóÔºü",
                faq4a: "ÊöÇ‰∏çÊîØÊåÅÔºåÊØèÊ¨°Âè™ËÉΩÁºñËæë‰∏ÄÂº†ÂõæÁâá„ÄÇ",
                faq5q: "ÂõæÁâá‰ºö‰∏ä‰º†Âà∞ÊúçÂä°Âô®ÂêóÔºü",
                faq5a: "‰∏ç‰ºöÔºåÊâÄÊúâÁºñËæëÂú®Êú¨Âú∞ÊµèËßàÂô®ÂÆåÊàê„ÄÇ",
                relatedTools: "üîó Áõ∏ÂÖ≥Â∑•ÂÖ∑Êé®Ëçê",
                toolCompressor: "ÂõæÁâáÂéãÁº©",
                toolCompressorDesc: "Âú®Á∫øÂéãÁº©ÂõæÁâáÂ§ßÂ∞è",
                toolConverter: "ÂõæÁâáÊ†ºÂºèËΩ¨Êç¢",
                toolConverterDesc: "PNG/JPG/WebP ‰∫íËΩ¨",
                toolIdPhoto: "ËØÅ‰ª∂ÁÖßÂà∂‰Ωú",
                toolIdPhotoDesc: "ËØÅ‰ª∂ÁÖßÊç¢Â∫ïËâ≤",
                toolPalette: "Ë∞ÉËâ≤Êùø",
                toolPaletteDesc: "È¢úËâ≤ÈÄâÊã©‰∏éËΩ¨Êç¢",
                footerText: "Á∫ØÂâçÁ´ØÂ§ÑÁêÜÔºåÊï∞ÊçÆ‰∏ç‰ºö‰∏ä‰º†Âà∞ÊúçÂä°Âô®",
                backToHome: "‚Üê ËøîÂõû Web Toolbox È¶ñÈ°µ",
                filterNone: "ÂéüÂõæ",
                filterGrayscale: "ÁÅ∞Â∫¶",
                filterInvert: "ÂèçËâ≤",
                filterSepia: "Ê£ïË§ê",
                filterVintage: "Â§çÂè§",
                filterCold: "ÂÜ∑Ë∞É",
                filterWarm: "ÊöñË∞É",
                filterBlur: "Ê®°Á≥ä",
                filterSharpen: "ÈîêÂåñ",
                filterEmboss: "ÊµÆÈõï",
                filterPixelate: "ÂÉèÁ¥†Âåñ",
                filterEdge: "ËæπÁºò",
                faq_free_q: "Ëøô‰∏™Â∑•ÂÖ∑ÁúüÁöÑÂÆåÂÖ®ÂÖçË¥πÊó†ÂπøÂëäÂêóÔºü",
                faq_free_a: "ÊòØÁöÑÔºå100% ÂÖçË¥πÔºåÊó†ÂπøÂëä„ÄÅÊó†ÈúÄÊ≥®ÂÜå„ÄÅÊó†Ê∞¥Âç∞„ÄÅÊó†‰ΩøÁî®ÈôêÂà∂„ÄÇÊâÄÊúâÂ§ÑÁêÜÈÉΩÂú®ÊµèËßàÂô®Êú¨Âú∞ÂÆåÊàê„ÄÇ",
                trust_users: "üåç Ë∂ÖËøá 50,000 Áî®Êà∑‰ΩøÁî®",
                trust_rating: "‚≠ê 4.9/5 Â•ΩËØÑ",
                trust_privacy: "üîí 100% ÈöêÁßÅÂÆâÂÖ®",
                trust_free: "üö´ Êó†ÂπøÂëä„ÄÅÊó†ÈúÄÊ≥®ÂÜå"
            },
            fr: {
                title: "Editeur d'images en ligne",
                backToToolbox: "‚Üê Retour √† la bo√Æte √† outils",
                openImage: "üìÇ Ouvrir image",
                undo: "‚Ü© Annuler",
                redo: "‚Ü™ R√©tablir",
                reset: "üîÑ R√©initialiser",
                saveImage: "üíæ Enregistrer",
                featureBasicTitle: "100% Gratuit et Priv√©",
                featureBasicDesc: "Sans publicit√©, sans inscription, sans filigrane. Tout est trait√© localement dans votre navigateur.",
                featureFilterTitle: "Effets de filtre",
                featureFilterDesc: "Luminosit√©, contraste, saturation, flou et plus de filtres",
                featureTextTitle: "Filigrane texte",
                featureTextDesc: "Ajouter des filigranes texte personnalis√©s avec police et position ajustables",
                featurePreviewTitle: "Aper√ßu en direct",
                featurePreviewDesc: "Tous les ajustements pr√©visualis√©s instantan√©ment",
                toolAdjust: "Ajuster",
                toolFilter: "Filtre",
                toolCrop: "Recadrer",
                toolTransform: "Transformer",
                toolDraw: "Dessiner",
                toolText: "Texte",
                toolChroma: "Chroma",
                uploadTitle: "D√©posez l'image ici",
                uploadDesc: "Ou cliquez pour s√©lectionner un fichier image (JPG, PNG, WebP, GIF)",
                ratioFree: "Libre",
                applyCrop: "‚úì Appliquer",
                cancel: "‚úï Annuler",
                panelAdjust: "üé® Ajuster",
                brightness: "Luminosit√©",
                contrast: "Contraste",
                saturation: "Saturation",
                hue: "Teinte",
                exposure: "Exposition",
                noise: "Bruit",
                panelFilter: "‚ú® Filtre",
                panelCrop: "‚úÇÔ∏è Recadrer",
                cropHint: "Cliquez sur le bouton ci-dessous pour entrer en mode recadrage",
                startCrop: "Commencer",
                panelTransform: "üîÑ Transformer",
                flip: "Retourner",
                flipHorizontal: "Horiz.",
                flipVertical: "Vert.",
                rotate: "Rotation",
                rotateLeft: "Gauche 90¬∞",
                rotateRight: "Droite 90¬∞",
                freeRotate: "Rotation libre",
                panelDraw: "‚úèÔ∏è Dessiner",
                tools: "Outils",
                brush: "Pinceau",
                line: "Ligne",
                rectangle: "Rect",
                circle: "Cercle",
                arrow: "Fl√®che",
                eraser: "Gomme",
                brushColor: "Couleur pinceau",
                brushSize: "Taille pinceau",
                clearDraw: "Effacer dessin",
                panelText: "üìù Texte",
                textPlaceholder: "Entrez le texte...",
                textColor: "Couleur texte",
                fontSize: "Taille police",
                bold: "Gras",
                shadow: "Ombre",
                addText: "Ajouter texte",
                textHint: "Faites glisser le texte pour ajuster la position",
                clearAllText: "Effacer tout",
                panelChroma: "üé≠ Cl√© chromatique",
                chromaHint: "S√©lectionnez la couleur de fond √† supprimer, ajustez la tol√©rance",
                selectBgColor: "Couleur fond",
                pickFromImage: "üéØ Pr√©lever couleur",
                tolerance: "Tol√©rance",
                feather: "Contour progressif",
                applyChroma: "Appliquer",
                faqTitle: "FAQ",
                faq1q: "Quels formats d'image sont pris en charge?",
                faq1a: "JPG, PNG, WebP, GIF, BMP et autres formats courants.",
                faq2q: "Puis-je annuler les modifications?",
                faq2a: "Oui, les fonctions annuler et r√©tablir sont prises en charge.",
                faq3q: "Quel est le format de l'image √©dit√©e?",
                faq3a: "Vous pouvez exporter en JPG, PNG ou WebP.",
                faq4q: "Puis-je √©diter des images en lot?",
                faq4a: "Non, une seule image √† la fois.",
                faq5q: "Les images sont-elles t√©l√©charg√©es sur un serveur?",
                faq5a: "Non, tout est trait√© localement dans votre navigateur.",
                relatedTools: "Outils connexes",
                toolCompressor: "Compresseur d'images",
                toolCompressorDesc: "Compresser la taille des images",
                toolConverter: "Convertisseur d'images",
                toolConverterDesc: "Conversion PNG/JPG/WebP",
                toolIdPhoto: "Photo d'identit√©",
                toolIdPhotoDesc: "Changer le fond de la photo",
                toolPalette: "Palette de couleurs",
                toolPaletteDesc: "S√©lection et conversion de couleurs",
                footerText: "Traitement frontend pur, donn√©es non t√©l√©charg√©es",
                backToHome: "Retour √† Web Toolbox",
                filterNone: "Original",
                filterGrayscale: "Gris",
                filterInvert: "Inverser",
                filterSepia: "S√©pia",
                filterVintage: "Vintage",
                filterCold: "Froid",
                filterWarm: "Chaud",
                filterBlur: "Flou",
                filterSharpen: "Nettet√©",
                filterEmboss: "Relief",
                filterPixelate: "Pixeliser",
                filterEdge: "Contour",
                faq_free_q: "Cet outil est-il vraiment gratuit sans publicit√© ?",
                faq_free_a: "Oui, 100% gratuit sans publicit√©, sans inscription, sans filigrane et sans limite d'utilisation.",
                trust_users: "üåç Utilis√© par 50 000+ utilisateurs",
                trust_rating: "‚≠ê Note 4.9/5",
                trust_privacy: "üîí 100% Priv√©",
                trust_free: "üö´ Sans pub, sans inscription"
            },
            es: {
                title: "Editor de im√°genes en l√≠nea",
                backToToolbox: "‚Üê Volver a herramientas",
                openImage: "üìÇ Abrir imagen",
                undo: "‚Ü© Deshacer",
                redo: "‚Ü™ Rehacer",
                reset: "üîÑ Restablecer",
                saveImage: "üíæ Guardar",
                featureBasicTitle: "100% Gratis y Privado",
                featureBasicDesc: "Sin anuncios, sin registro, sin marca de agua. Todo se procesa localmente en tu navegador.",
                featureFilterTitle: "Efectos de filtro",
                featureFilterDesc: "Brillo, contraste, saturaci√≥n, desenfoque y m√°s filtros",
                featureTextTitle: "Marca de agua",
                featureTextDesc: "Agregar marcas de agua de texto personalizadas con fuente y posici√≥n ajustables",
                featurePreviewTitle: "Vista previa en vivo",
                featurePreviewDesc: "Todos los ajustes se previsualizan instant√°neamente",
                toolAdjust: "Ajustar",
                toolFilter: "Filtro",
                toolCrop: "Recortar",
                toolTransform: "Transformar",
                toolDraw: "Dibujar",
                toolText: "Texto",
                toolChroma: "Croma",
                uploadTitle: "Arrastra la imagen aqu√≠",
                uploadDesc: "O haz clic para seleccionar archivo (JPG, PNG, WebP, GIF)",
                ratioFree: "Libre",
                applyCrop: "‚úì Aplicar",
                cancel: "‚úï Cancelar",
                panelAdjust: "üé® Ajustar",
                brightness: "Brillo",
                contrast: "Contraste",
                saturation: "Saturaci√≥n",
                hue: "Tono",
                exposure: "Exposici√≥n",
                noise: "Ruido",
                panelFilter: "‚ú® Filtro",
                panelCrop: "‚úÇÔ∏è Recortar",
                cropHint: "Haz clic en el bot√≥n de abajo para entrar en modo recorte",
                startCrop: "Iniciar recorte",
                panelTransform: "üîÑ Transformar",
                flip: "Voltear",
                flipHorizontal: "Horiz.",
                flipVertical: "Vert.",
                rotate: "Rotar",
                rotateLeft: "Izq. 90¬∞",
                rotateRight: "Der. 90¬∞",
                freeRotate: "Rotaci√≥n libre",
                panelDraw: "‚úèÔ∏è Dibujar",
                tools: "Herramientas",
                brush: "Pincel",
                line: "L√≠nea",
                rectangle: "Rect",
                circle: "C√≠rculo",
                arrow: "Flecha",
                eraser: "Borrador",
                brushColor: "Color pincel",
                brushSize: "Tama√±o pincel",
                clearDraw: "Borrar dibujo",
                panelText: "üìù Texto",
                textPlaceholder: "Ingresa el texto...",
                textColor: "Color texto",
                fontSize: "Tama√±o fuente",
                bold: "Negrita",
                shadow: "Sombra",
                addText: "Agregar texto",
                textHint: "Arrastra el texto para ajustar la posici√≥n",
                clearAllText: "Borrar todo",
                panelChroma: "üé≠ Clave de croma",
                chromaHint: "Selecciona el color de fondo a eliminar, ajusta la tolerancia",
                selectBgColor: "Color fondo",
                pickFromImage: "üéØ Tomar color",
                tolerance: "Tolerancia",
                feather: "Difuminar borde",
                applyChroma: "Aplicar",
                faqTitle: "Preguntas frecuentes",
                faq1q: "¬øQu√© formatos de imagen son compatibles?",
                faq1a: "JPG, PNG, WebP, GIF, BMP y otros formatos comunes.",
                faq2q: "¬øPuedo deshacer ediciones?",
                faq2a: "S√≠, se admiten las funciones de deshacer y rehacer.",
                faq3q: "¬øEn qu√© formato se guarda la imagen editada?",
                faq3a: "Puedes exportar como JPG, PNG o WebP.",
                faq4q: "¬øPuedo editar im√°genes en lote?",
                faq4a: "No, solo una imagen a la vez.",
                faq5q: "¬øSe suben las im√°genes a un servidor?",
                faq5a: "No, todo se procesa localmente en tu navegador.",
                relatedTools: "Herramientas relacionadas",
                toolCompressor: "Compresor de im√°genes",
                toolCompressorDesc: "Comprimir tama√±o de imagen",
                toolConverter: "Convertidor de im√°genes",
                toolConverterDesc: "Conversi√≥n PNG/JPG/WebP",
                toolIdPhoto: "Foto de identificaci√≥n",
                toolIdPhotoDesc: "Cambiar fondo de foto",
                toolPalette: "Paleta de colores",
                toolPaletteDesc: "Selecci√≥n y conversi√≥n de colores",
                footerText: "Procesamiento frontend puro, datos no se suben al servidor",
                backToHome: "Volver a Web Toolbox",
                filterNone: "Original",
                filterGrayscale: "Grises",
                filterInvert: "Invertir",
                filterSepia: "Sepia",
                filterVintage: "Vintage",
                filterCold: "Fr√≠o",
                filterWarm: "C√°lido",
                filterBlur: "Desenfoque",
                filterSharpen: "Nitidez",
                filterEmboss: "Relieve",
                filterPixelate: "Pixelar",
                filterEdge: "Borde",
                faq_free_q: "¬øEsta herramienta es realmente gratuita sin anuncios?",
                faq_free_a: "S√≠, 100% gratuita sin anuncios, sin registro, sin marca de agua y sin l√≠mites de uso.",
                trust_users: "üåç Usado por m√°s de 50,000 usuarios",
                trust_rating: "‚≠ê Calificaci√≥n 4.9/5",
                trust_privacy: "üîí 100% Privado",
                trust_free: "üö´ Sin anuncios, sin registro"
            }
        };

        const langNames = {
            en: "üá∫üá∏ English",
            "zh-CN": "üá®üá≥ ‰∏≠Êñá",
            fr: "üá´üá∑ Fran√ßais",
            es: "üá™üá∏ Espa√±ol"
        };

        function setLanguage(lang) {
            if (!i18n[lang]) lang = 'en';
            localStorage.setItem('language', lang);
            document.getElementById('langCurrent').textContent = langNames[lang] || langNames.en;

            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (i18n[lang][key]) {
                    el.textContent = i18n[lang][key];
                }
            });

            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (i18n[lang][key]) {
                    el.placeholder = i18n[lang][key];
                }
            });

            // Êõ¥Êñ∞Êª§ÈïúÂêçÁß∞
            updateFilterNames(lang);
        }

        function updateFilterNames(lang) {
            const filterMap = {
                'none': 'filterNone',
                'grayscale': 'filterGrayscale',
                'invert': 'filterInvert',
                'sepia': 'filterSepia',
                'vintage': 'filterVintage',
                'cold': 'filterCold',
                'warm': 'filterWarm',
                'blur': 'filterBlur',
                'sharpen': 'filterSharpen',
                'emboss': 'filterEmboss',
                'pixelate': 'filterPixelate',
                'edge': 'filterEdge'
            };

            document.querySelectorAll('.filter-item').forEach(item => {
                const filterId = item.getAttribute('data-filter');
                const nameEl = item.querySelector('.filter-name');
                if (nameEl && filterMap[filterId] && i18n[lang][filterMap[filterId]]) {
                    nameEl.textContent = i18n[lang][filterMap[filterId]];
                }
            });
        }

        // ËØ≠Ë®ÄÂàáÊç¢Âô®‰∫ã‰ª∂
        document.getElementById('langDropdown').addEventListener('click', function(e) {
            this.classList.toggle('active');
        });

        document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                setLanguage(this.getAttribute('data-lang'));
                document.getElementById('langDropdown').classList.remove('active');
            });
        });

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.lang-dropdown')) {
                document.getElementById('langDropdown').classList.remove('active');
            }
        });

        // ÂàùÂßãÂåñËØ≠Ë®Ä
        const savedLang = localStorage.getItem('language') || (navigator.language.startsWith('zh') ? 'zh-CN' : navigator.language.startsWith('fr') ? 'fr' : navigator.language.startsWith('es') ? 'es' : 'en');
        setLanguage(savedLang);
    </script>

    <!-- FAQ ÈóÆÁ≠îÂå∫Âùó -->
    <section class="faq-section" style="max-width: 900px; margin: 40px auto; padding: 0 20px;">
        <h2 style="color: #e6edf3; font-size: 20px; margin-bottom: 24px; padding-bottom: 12px; border-bottom: 1px solid #30363d;" data-i18n="faqTitle">FAQ</h2>
        <div style="display: flex; flex-direction: column; gap: 16px;">
            <details style="background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 16px;">
                <summary style="color: #e6edf3; font-weight: 500; cursor: pointer; list-style: none; display: flex; justify-content: space-between; align-items: center;">
                    <span data-i18n="faq1q">What image formats are supported?</span>
                    <span style="color: #8b949e; font-size: 18px;">+</span>
                </summary>
                <p style="color: #8b949e; margin-top: 12px; padding-top: 12px; border-top: 1px solid #30363d; line-height: 1.6;" data-i18n="faq1a">Supports JPG, PNG, WebP, GIF, BMP and other common image formats.</p>
            </details>
            <details style="background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 16px;">
                <summary style="color: #e6edf3; font-weight: 500; cursor: pointer; list-style: none; display: flex; justify-content: space-between; align-items: center;">
                    <span data-i18n="faq2q">Can I undo edits?</span>
                    <span style="color: #8b949e; font-size: 18px;">+</span>
                </summary>
                <p style="color: #8b949e; margin-top: 12px; padding-top: 12px; border-top: 1px solid #30363d; line-height: 1.6;" data-i18n="faq2a">Yes, undo and redo functions are supported.</p>
            </details>
            <details style="background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 16px;">
                <summary style="color: #e6edf3; font-weight: 500; cursor: pointer; list-style: none; display: flex; justify-content: space-between; align-items: center;">
                    <span data-i18n="faq3q">What format is the edited image?</span>
                    <span style="color: #8b949e; font-size: 18px;">+</span>
                </summary>
                <p style="color: #8b949e; margin-top: 12px; padding-top: 12px; border-top: 1px solid #30363d; line-height: 1.6;" data-i18n="faq3a">You can choose to export as JPG, PNG, or WebP format.</p>
            </details>
            <details style="background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 16px;">
                <summary style="color: #e6edf3; font-weight: 500; cursor: pointer; list-style: none; display: flex; justify-content: space-between; align-items: center;">
                    <span data-i18n="faq4q">Can I batch edit images?</span>
                    <span style="color: #8b949e; font-size: 18px;">+</span>
                </summary>
                <p style="color: #8b949e; margin-top: 12px; padding-top: 12px; border-top: 1px solid #30363d; line-height: 1.6;" data-i18n="faq4a">Not currently supported, only one image can be edited at a time.</p>
            </details>
            <details style="background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 16px;">
                <summary style="color: #e6edf3; font-weight: 500; cursor: pointer; list-style: none; display: flex; justify-content: space-between; align-items: center;">
                    <span data-i18n="faq5q">Are images uploaded to a server?</span>
                    <span style="color: #8b949e; font-size: 18px;">+</span>
                </summary>
                <p style="color: #8b949e; margin-top: 12px; padding-top: 12px; border-top: 1px solid #30363d; line-height: 1.6;" data-i18n="faq5a">No, all editing is done locally in your browser.</p>
            </details>
            <details style="background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 16px;">
                <summary style="color: #e6edf3; font-weight: 500; cursor: pointer; list-style: none; display: flex; justify-content: space-between; align-items: center;">
                    <span data-i18n="faq_free_q">Is this tool really free with no ads?</span>
                    <span style="color: #8b949e; font-size: 18px;">+</span>
                </summary>
                <p style="color: #8b949e; margin-top: 12px; padding-top: 12px; border-top: 1px solid #30363d; line-height: 1.6;" data-i18n="faq_free_a">Yes, 100% free with no ads, no registration, no watermark, and no usage limits. All processing happens locally in your browser ‚Äî your data is never uploaded to any server.</p>
            </details>
        </div>
    </section>

    <!-- Áõ∏ÂÖ≥Â∑•ÂÖ∑Êé®Ëçê -->
    <section class="related-tools" style="max-width: 900px; margin: 40px auto; padding: 0 20px;">
        <h3 style="color: #e6edf3; font-size: 18px; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #30363d;" data-i18n="relatedTools">Related Tools</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
            <a href="image-compressor.html" style="display: block; padding: 16px; background: #161b22; border: 1px solid #30363d; border-radius: 8px; text-decoration: none; transition: all 0.2s;">
                <div style="font-size: 24px; margin-bottom: 8px;">üóúÔ∏è</div>
                <div style="color: #e6edf3; font-weight: 500;" data-i18n="toolCompressor">Image Compressor</div>
                <div style="color: #8b949e; font-size: 12px; margin-top: 4px;" data-i18n="toolCompressorDesc">Compress image size online</div>
            </a>
            <a href="image-converter.html" style="display: block; padding: 16px; background: #161b22; border: 1px solid #30363d; border-radius: 8px; text-decoration: none; transition: all 0.2s;">
                <div style="font-size: 24px; margin-bottom: 8px;">üîÑ</div>
                <div style="color: #e6edf3; font-weight: 500;" data-i18n="toolConverter">Image Converter</div>
                <div style="color: #8b949e; font-size: 12px; margin-top: 4px;" data-i18n="toolConverterDesc">PNG/JPG/WebP conversion</div>
            </a>
            <a href="id-photo-tool.html" style="display: block; padding: 16px; background: #161b22; border: 1px solid #30363d; border-radius: 8px; text-decoration: none; transition: all 0.2s;">
                <div style="font-size: 24px; margin-bottom: 8px;">üì∑</div>
                <div style="color: #e6edf3; font-weight: 500;" data-i18n="toolIdPhoto">ID Photo Maker</div>
                <div style="color: #8b949e; font-size: 12px; margin-top: 4px;" data-i18n="toolIdPhotoDesc">Change ID photo background</div>
            </a>
            <a href="color-palette.html" style="display: block; padding: 16px; background: #161b22; border: 1px solid #30363d; border-radius: 8px; text-decoration: none; transition: all 0.2s;">
                <div style="font-size: 24px; margin-bottom: 8px;">üé®</div>
                <div style="color: #e6edf3; font-weight: 500;" data-i18n="toolPalette">Color Palette</div>
                <div style="color: #8b949e; font-size: 12px; margin-top: 4px;" data-i18n="toolPaletteDesc">Color selection and conversion</div>
            </a>
        </div>
    </section>

    <footer style="text-align: center; padding: 30px 20px; border-top: 1px solid #30363d; color: #8b949e; font-size: 14px;">
        <p data-i18n="footerText">Pure frontend processing, data is not uploaded to server</p>
        <p style="margin-top: 12px;">
            <a href="index.html" style="color: #58a6ff; text-decoration: none;" data-i18n="backToHome">Back to Web Toolbox</a>
            <span style="margin: 0 12px;">|</span>
            <a href="https://github.com/heyuan110" target="_blank" rel="noopener" style="color: #58a6ff; text-decoration: none;">GitHub</a>
        </p>
    </footer>
</body>
</html>
