<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Code å†å²è®°å½•æŸ¥çœ‹å™¨ - åœ¨çº¿å·¥å…·ç®±</title>
    <meta name="description" content="æŸ¥çœ‹å’Œæœç´¢ Claude Code çš„å†å²å¯¹è¯è®°å½•ï¼Œæ”¯æŒ JSONL æ ¼å¼å¯¼å…¥ï¼Œç¾è§‚æ˜“ç”¨çš„ç•Œé¢">
    <meta name="keywords" content="Claude Code,å†å²è®°å½•,å¯¹è¯æŸ¥çœ‹å™¨,AIå¯¹è¯,JSONL,Claudeå¯¹è¯,AIç¼–ç¨‹åŠ©æ‰‹">
    <meta name="author" content="heyuan110">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://www.heyuan110.com/web-toolbox/claude-history-viewer.html">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ’¬</text></svg>">

    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://www.heyuan110.com/web-toolbox/claude-history-viewer.html">
    <meta property="og:title" content="Claude Code å†å²è®°å½•æŸ¥çœ‹å™¨ - åœ¨çº¿å·¥å…·">
    <meta property="og:description" content="æŸ¥çœ‹å’Œæœç´¢ Claude Code çš„å†å²å¯¹è¯è®°å½•ï¼Œæ”¯æŒ JSONL æ ¼å¼å¯¼å…¥ã€‚">
    <meta property="og:image" content="https://www.heyuan110.com/web-toolbox/screenshots/claude-history-viewer.png">
    <meta property="og:locale" content="zh_CN">
    <meta property="og:site_name" content="Web Toolbox">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Claude Code å†å²è®°å½•æŸ¥çœ‹å™¨">
    <meta name="twitter:description" content="æŸ¥çœ‹å’Œæœç´¢ Claude Code çš„å†å²å¯¹è¯è®°å½•ã€‚">
    <meta name="twitter:image" content="https://www.heyuan110.com/web-toolbox/screenshots/claude-history-viewer.png">

    <!-- JSON-LD -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Claude Code å†å²è®°å½•æŸ¥çœ‹å™¨",
        "url": "https://www.heyuan110.com/web-toolbox/claude-history-viewer.html",
        "description": "æŸ¥çœ‹å’Œæœç´¢ Claude Code çš„å†å²å¯¹è¯è®°å½•",
        "applicationCategory": "DeveloperApplication",
        "operatingSystem": "Web Browser",
        "offers": {"@type": "Offer", "price": "0", "priceCurrency": "CNY"},
        "author": {"@type": "Person", "name": "heyuan110"}
    }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-card: #0f3460;
            --bg-hover: #1a4a7a;
            --text-primary: #eee;
            --text-secondary: #aaa;
            --text-muted: #666;
            --accent: #e94560;
            --accent-light: #ff6b6b;
            --success: #4ecdc4;
            --warning: #ffd93d;
            --border: #2a2a4a;
            --user-bg: #2d5a27;
            --assistant-bg: #1e3a5f;
            --tool-bg: #3d2d5a;
            --code-bg: #0d1117;
            --scrollbar: #444;
            --scrollbar-thumb: #666;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--scrollbar);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #888;
        }

        /* å¤´éƒ¨å¯¼èˆª */
        .header {
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-card));
            padding: 20px;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            font-size: 32px;
        }

        .logo-text h1 {
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--accent), var(--accent-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo-text span {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent), var(--accent-light));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(233, 69, 96, 0.4);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        /* ä¸»å¸ƒå±€ */
        .main-container {
            display: flex;
            max-width: 1600px;
            margin: 0 auto;
            min-height: calc(100vh - 90px);
        }

        /* ä¾§è¾¹æ  */
        .sidebar {
            width: 320px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 15px;
            border-bottom: 1px solid var(--border);
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .search-box::after {
            content: 'ğŸ”';
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1rem;
        }

        .session-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .session-item {
            padding: 12px 15px;
            background: var(--bg-card);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .session-item:hover {
            background: var(--bg-hover);
            border-color: var(--accent);
        }

        .session-item.active {
            border-color: var(--accent);
            background: var(--bg-hover);
        }

        .session-title {
            font-weight: 500;
            margin-bottom: 5px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .session-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .session-project {
            color: var(--success);
            font-size: 0.7rem;
            margin-top: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* å†…å®¹åŒºåŸŸ */
        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* ä¸Šä¼ åŒºåŸŸ */
        .upload-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .upload-box {
            text-align: center;
            padding: 60px 40px;
            border: 2px dashed var(--border);
            border-radius: 16px;
            background: var(--bg-secondary);
            max-width: 600px;
            width: 100%;
            transition: all 0.3s ease;
        }

        .upload-box:hover,
        .upload-box.drag-over {
            border-color: var(--accent);
            background: var(--bg-card);
        }

        .upload-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .upload-title {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .upload-desc {
            color: var(--text-secondary);
            margin-bottom: 25px;
        }

        .upload-hint {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 20px;
        }

        .upload-hint code {
            background: var(--code-bg);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', monospace;
        }

        /* å¯¹è¯è§†å›¾ */
        .conversation-view {
            flex: 1;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .conversation-header {
            padding: 15px 20px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .conversation-title {
            font-size: 1.1rem;
            font-weight: 500;
        }

        .conversation-info {
            display: flex;
            gap: 15px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .conversation-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        /* æ¶ˆæ¯æ ·å¼ */
        .message {
            margin-bottom: 20px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .message-user .message-avatar {
            background: var(--user-bg);
        }

        .message-assistant .message-avatar {
            background: var(--assistant-bg);
        }

        .message-tool .message-avatar {
            background: var(--tool-bg);
        }

        .message-role {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .message-time {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .message-content {
            padding: 15px 20px;
            border-radius: 12px;
            margin-left: 42px;
            line-height: 1.7;
        }

        .message-user .message-content {
            background: var(--user-bg);
            border-left: 3px solid #4caf50;
        }

        .message-assistant .message-content {
            background: var(--assistant-bg);
            border-left: 3px solid #2196f3;
        }

        .message-tool .message-content {
            background: var(--tool-bg);
            border-left: 3px solid #9c27b0;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.85rem;
        }

        .message-thinking {
            background: #2a2a3a;
            border-left: 3px solid #ff9800;
            font-style: italic;
            color: var(--text-secondary);
        }

        /* ä»£ç å— */
        .message-content pre {
            background: var(--code-bg);
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 10px 0;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
        }

        .message-content code {
            background: var(--code-bg);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 0.9em;
        }

        .message-content pre code {
            background: transparent;
            padding: 0;
        }

        /* å·¥å…·è°ƒç”¨è¯¦æƒ… */
        .tool-call {
            background: var(--code-bg);
            border-radius: 8px;
            margin: 10px 0;
            overflow: hidden;
        }

        .tool-call-header {
            padding: 10px 15px;
            background: rgba(156, 39, 176, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .tool-call-name {
            font-weight: 600;
            color: #ce93d8;
        }

        .tool-call-toggle {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .tool-call-body {
            padding: 15px;
            display: none;
            max-height: 400px;
            overflow: auto;
        }

        .tool-call.expanded .tool-call-body {
            display: block;
        }

        /* ç»Ÿè®¡é¢æ¿ */
        .stats-panel {
            padding: 15px;
            background: var(--bg-card);
            border-radius: 8px;
            margin: 10px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--accent);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        /* æ–‡ä»¶è¾“å…¥éšè— */
        input[type="file"] {
            display: none;
        }

        /* æ ‡ç­¾ */
        .tag {
            display: inline-block;
            padding: 2px 8px;
            font-size: 0.7rem;
            border-radius: 4px;
            margin-right: 5px;
        }

        .tag-user {
            background: var(--user-bg);
        }

        .tag-assistant {
            background: var(--assistant-bg);
        }

        .tag-tool {
            background: var(--tool-bg);
        }

        /* ç­›é€‰å™¨ */
        .filter-bar {
            padding: 10px 15px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 5px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 15px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-btn:hover,
        .filter-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        /* å“åº”å¼ */
        @media (max-width: 900px) {
            .main-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                max-height: 300px;
            }

            .header-content {
                flex-direction: column;
                text-align: center;
            }
        }

        /* è¿”å›é¦–é¡µé“¾æ¥ */
        .back-link {
            color: var(--text-secondary);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }

        .back-link:hover {
            color: var(--accent);
        }

        /* é«˜äº®æœç´¢ç»“æœ */
        .highlight {
            background: rgba(233, 69, 96, 0.4);
            padding: 0 2px;
            border-radius: 2px;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* æŠ˜å æŒ‰é’® */
        .collapse-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 5px;
            font-size: 0.8rem;
        }

        .collapse-btn:hover {
            color: var(--accent);
        }

        /* æ¶ˆæ¯å†…å®¹ä¸­çš„é“¾æ¥ */
        .message-content a {
            color: var(--accent-light);
            text-decoration: none;
        }

        .message-content a:hover {
            text-decoration: underline;
        }

        /* å¯¼å‡ºæŒ‰é’® */
        .export-menu {
            position: relative;
        }

        .export-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 0;
            min-width: 150px;
            display: none;
            z-index: 10;
        }

        .export-dropdown.show {
            display: block;
        }

        .export-option {
            display: block;
            width: 100%;
            padding: 8px 15px;
            text-align: left;
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.9rem;
        }

        .export-option:hover {
            background: var(--bg-hover);
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <span class="logo-icon">ğŸ’¬</span>
                <div class="logo-text">
                    <h1>Claude Code å†å²è®°å½•</h1>
                    <span>æŸ¥çœ‹å’Œæœç´¢ä½ çš„å¯¹è¯å†å²</span>
                </div>
            </div>
            <div class="header-actions">
                <a href="index.html" class="back-link">â† è¿”å›å·¥å…·ç®±</a>
                <label for="file-input" class="btn btn-primary">
                    ğŸ“‚ å¯¼å…¥æ–‡ä»¶
                </label>
                <label for="folder-input" class="btn btn-secondary">
                    ğŸ“ å¯¼å…¥æ–‡ä»¶å¤¹
                </label>
            </div>
        </div>
    </header>

    <input type="file" id="file-input" accept=".jsonl,.json" multiple>
    <input type="file" id="folder-input" webkitdirectory>

    <main class="main-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="search-box">
                    <input type="text" id="search-input" placeholder="æœç´¢å¯¹è¯å†…å®¹...">
                </div>
            </div>
            <div class="stats-panel" id="stats-panel" style="display: none;">
                <div class="stat-item">
                    <div class="stat-value" id="stat-sessions">0</div>
                    <div class="stat-label">å¯¹è¯æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="stat-messages">0</div>
                    <div class="stat-label">æ¶ˆæ¯æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="stat-projects">0</div>
                    <div class="stat-label">é¡¹ç›®æ•°</div>
                </div>
            </div>
            <div class="session-list" id="session-list">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“‹</div>
                    <p>æš‚æ— å¯¹è¯è®°å½•</p>
                    <p style="font-size: 0.8rem; margin-top: 10px;">è¯·å¯¼å…¥ JSONL æ–‡ä»¶</p>
                </div>
            </div>
        </aside>

        <section class="content">
            <div class="upload-area" id="upload-area">
                <div class="upload-box" id="upload-box">
                    <div class="upload-icon">ğŸ“¤</div>
                    <h2 class="upload-title">å¯¼å…¥ Claude Code å†å²è®°å½•</h2>
                    <p class="upload-desc">æ‹–æ‹½ JSONL æ–‡ä»¶åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»æŒ‰é’®é€‰æ‹©æ–‡ä»¶</p>
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <label for="file-input" class="btn btn-primary">
                            ğŸ“‚ é€‰æ‹©æ–‡ä»¶
                        </label>
                        <label for="folder-input" class="btn btn-secondary">
                            ğŸ“ é€‰æ‹©æ–‡ä»¶å¤¹
                        </label>
                    </div>
                    <p class="upload-hint">
                        å†å²è®°å½•ä½ç½®ï¼š<code>~/.claude/projects/</code>
                        <br><br>
                        æ”¯æŒå¯¼å…¥å•ä¸ª .jsonl æ–‡ä»¶æˆ–æ•´ä¸ªé¡¹ç›®æ–‡ä»¶å¤¹
                    </p>
                </div>
            </div>

            <div class="conversation-view" id="conversation-view">
                <div class="conversation-header">
                    <div>
                        <div class="conversation-title" id="conversation-title">å¯¹è¯æ ‡é¢˜</div>
                        <div class="conversation-info">
                            <span id="conversation-date">æ—¥æœŸ</span>
                            <span id="conversation-count">æ¶ˆæ¯æ•°</span>
                        </div>
                    </div>
                    <div class="export-menu">
                        <button class="btn btn-secondary btn-small" id="export-btn">
                            ğŸ“¥ å¯¼å‡º
                        </button>
                        <div class="export-dropdown" id="export-dropdown">
                            <button class="export-option" data-format="markdown">å¯¼å‡ºä¸º Markdown</button>
                            <button class="export-option" data-format="json">å¯¼å‡ºä¸º JSON</button>
                            <button class="export-option" data-format="text">å¯¼å‡ºä¸ºçº¯æ–‡æœ¬</button>
                        </div>
                    </div>
                </div>
                <div class="filter-bar">
                    <button class="filter-btn active" data-filter="all">å…¨éƒ¨</button>
                    <button class="filter-btn" data-filter="user">ç”¨æˆ·æ¶ˆæ¯</button>
                    <button class="filter-btn" data-filter="assistant">AI å›å¤</button>
                    <button class="filter-btn" data-filter="tool">å·¥å…·è°ƒç”¨</button>
                    <button class="filter-btn" data-filter="thinking">æ€è€ƒè¿‡ç¨‹</button>
                </div>
                <div class="conversation-messages" id="conversation-messages">
                </div>
            </div>
        </section>
    </main>

    <script>
        // å…¨å±€æ•°æ®å­˜å‚¨
        let allSessions = [];
        let currentSession = null;
        let currentFilter = 'all';
        let searchQuery = '';

        // DOM å…ƒç´ 
        const fileInput = document.getElementById('file-input');
        const folderInput = document.getElementById('folder-input');
        const uploadArea = document.getElementById('upload-area');
        const uploadBox = document.getElementById('upload-box');
        const conversationView = document.getElementById('conversation-view');
        const sessionList = document.getElementById('session-list');
        const searchInput = document.getElementById('search-input');
        const statsPanel = document.getElementById('stats-panel');
        const exportBtn = document.getElementById('export-btn');
        const exportDropdown = document.getElementById('export-dropdown');

        // äº‹ä»¶ç›‘å¬
        fileInput.addEventListener('change', handleFileSelect);
        folderInput.addEventListener('change', handleFolderSelect);
        searchInput.addEventListener('input', debounce(handleSearch, 300));

        // æ‹–æ‹½ä¸Šä¼ 
        uploadBox.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadBox.classList.add('drag-over');
        });

        uploadBox.addEventListener('dragleave', () => {
            uploadBox.classList.remove('drag-over');
        });

        uploadBox.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadBox.classList.remove('drag-over');
            const items = e.dataTransfer.items;
            handleDroppedItems(items);
        });

        // ç­›é€‰å™¨
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentFilter = btn.dataset.filter;
                if (currentSession) {
                    renderMessages(currentSession.messages);
                }
            });
        });

        // å¯¼å‡ºèœå•
        exportBtn.addEventListener('click', () => {
            exportDropdown.classList.toggle('show');
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.export-menu')) {
                exportDropdown.classList.remove('show');
            }
        });

        document.querySelectorAll('.export-option').forEach(opt => {
            opt.addEventListener('click', () => {
                if (currentSession) {
                    exportConversation(opt.dataset.format);
                }
                exportDropdown.classList.remove('show');
            });
        });

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            processFiles(files);
        }

        // å¤„ç†æ–‡ä»¶å¤¹é€‰æ‹©
        function handleFolderSelect(e) {
            const files = Array.from(e.target.files).filter(f =>
                f.name.endsWith('.jsonl') || f.name.endsWith('.json')
            );
            processFiles(files);
        }

        // å¤„ç†æ‹–æ‹½çš„é¡¹ç›®
        async function handleDroppedItems(items) {
            const files = [];

            for (const item of items) {
                if (item.kind === 'file') {
                    const entry = item.webkitGetAsEntry();
                    if (entry) {
                        if (entry.isFile) {
                            const file = item.getAsFile();
                            if (file.name.endsWith('.jsonl') || file.name.endsWith('.json')) {
                                files.push(file);
                            }
                        } else if (entry.isDirectory) {
                            await traverseDirectory(entry, files);
                        }
                    }
                }
            }

            processFiles(files);
        }

        // éå†ç›®å½•
        async function traverseDirectory(entry, files) {
            const reader = entry.createReader();
            const entries = await new Promise(resolve => reader.readEntries(resolve));

            for (const e of entries) {
                if (e.isFile && (e.name.endsWith('.jsonl') || e.name.endsWith('.json'))) {
                    const file = await new Promise(resolve => e.file(resolve));
                    files.push(file);
                } else if (e.isDirectory) {
                    await traverseDirectory(e, files);
                }
            }
        }

        // å¤„ç†æ–‡ä»¶
        async function processFiles(files) {
            if (files.length === 0) return;

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            sessionList.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';

            for (const file of files) {
                try {
                    const content = await file.text();
                    parseJSONL(content, file.name);
                } catch (err) {
                    console.error('è§£ææ–‡ä»¶å¤±è´¥:', file.name, err);
                }
            }

            // æ›´æ–° UI
            updateStats();
            renderSessionList();

            if (allSessions.length > 0) {
                uploadArea.style.display = 'none';
                statsPanel.style.display = 'grid';
            }
        }

        // è§£æ JSONL æ ¼å¼
        function parseJSONL(content, filename) {
            const lines = content.split('\n').filter(line => line.trim());

            // æ£€æŸ¥æ˜¯å¦æ˜¯å…¨å±€å†å²è®°å½•
            if (filename === 'history.jsonl') {
                parseGlobalHistory(lines);
                return;
            }

            // è§£æå¯¹è¯è®°å½•
            const messages = [];
            let summary = '';
            let sessionId = filename.replace('.jsonl', '');
            let project = '';
            let firstTimestamp = null;
            let lastTimestamp = null;

            for (const line of lines) {
                try {
                    const item = JSON.parse(line);

                    if (item.type === 'summary') {
                        summary = item.summary;
                    } else if (item.type === 'user' || item.type === 'assistant') {
                        if (item.sessionId) sessionId = item.sessionId;
                        if (item.cwd) project = item.cwd;

                        const timestamp = item.timestamp ? new Date(item.timestamp) : null;
                        if (timestamp) {
                            if (!firstTimestamp) firstTimestamp = timestamp;
                            lastTimestamp = timestamp;
                        }

                        messages.push({
                            type: item.type,
                            role: item.message?.role || item.type,
                            content: item.message?.content || '',
                            timestamp: timestamp,
                            uuid: item.uuid
                        });
                    }
                } catch (err) {
                    // å¿½ç•¥è§£æé”™è¯¯çš„è¡Œ
                }
            }

            if (messages.length > 0) {
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒ sessionId
                const existingIndex = allSessions.findIndex(s => s.sessionId === sessionId);
                const session = {
                    sessionId,
                    filename,
                    summary: summary || getFirstUserMessage(messages) || 'æœªå‘½åå¯¹è¯',
                    project,
                    messages,
                    firstTimestamp,
                    lastTimestamp,
                    messageCount: messages.length
                };

                if (existingIndex >= 0) {
                    allSessions[existingIndex] = session;
                } else {
                    allSessions.push(session);
                }
            }
        }

        // è§£æå…¨å±€å†å²
        function parseGlobalHistory(lines) {
            for (const line of lines) {
                try {
                    const item = JSON.parse(line);
                    // å…¨å±€å†å²ä¸»è¦ç”¨äºæœç´¢ï¼Œä¸å•ç‹¬æ˜¾ç¤º
                } catch (err) {
                    // å¿½ç•¥
                }
            }
        }

        // è·å–ç¬¬ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ä½œä¸ºæ ‡é¢˜
        function getFirstUserMessage(messages) {
            const userMsg = messages.find(m => m.role === 'user');
            if (userMsg && userMsg.content) {
                const text = extractTextContent(userMsg.content);
                return text.slice(0, 100) + (text.length > 100 ? '...' : '');
            }
            return null;
        }

        // æå–æ–‡æœ¬å†…å®¹
        function extractTextContent(content) {
            if (typeof content === 'string') return content;
            if (Array.isArray(content)) {
                return content
                    .filter(c => c.type === 'text')
                    .map(c => c.text)
                    .join('\n');
            }
            return '';
        }

        // æ›´æ–°ç»Ÿè®¡
        function updateStats() {
            const totalMessages = allSessions.reduce((sum, s) => sum + s.messageCount, 0);
            const projects = new Set(allSessions.map(s => s.project)).size;

            document.getElementById('stat-sessions').textContent = allSessions.length;
            document.getElementById('stat-messages').textContent = totalMessages;
            document.getElementById('stat-projects').textContent = projects;
        }

        // æ¸²æŸ“ä¼šè¯åˆ—è¡¨
        function renderSessionList() {
            // æŒ‰æ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
            const sortedSessions = [...allSessions].sort((a, b) => {
                const timeA = a.lastTimestamp || a.firstTimestamp || new Date(0);
                const timeB = b.lastTimestamp || b.firstTimestamp || new Date(0);
                return timeB - timeA;
            });

            // è¿‡æ»¤æœç´¢ç»“æœ
            const filtered = searchQuery
                ? sortedSessions.filter(s =>
                    s.summary.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    s.messages.some(m => {
                        const text = extractTextContent(m.content);
                        return text.toLowerCase().includes(searchQuery.toLowerCase());
                    })
                )
                : sortedSessions;

            if (filtered.length === 0) {
                sessionList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ”</div>
                        <p>æœªæ‰¾åˆ°åŒ¹é…çš„å¯¹è¯</p>
                    </div>
                `;
                return;
            }

            sessionList.innerHTML = filtered.map(session => `
                <div class="session-item ${currentSession?.sessionId === session.sessionId ? 'active' : ''}"
                     data-session-id="${session.sessionId}">
                    <div class="session-title">${escapeHtml(session.summary)}</div>
                    <div class="session-meta">
                        <span>${session.messageCount} æ¡æ¶ˆæ¯</span>
                        <span>${formatDate(session.lastTimestamp || session.firstTimestamp)}</span>
                    </div>
                    ${session.project ? `<div class="session-project">ğŸ“ ${getShortPath(session.project)}</div>` : ''}
                </div>
            `).join('');

            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.session-item').forEach(item => {
                item.addEventListener('click', () => {
                    const sessionId = item.dataset.sessionId;
                    const session = allSessions.find(s => s.sessionId === sessionId);
                    if (session) {
                        selectSession(session);
                    }
                });
            });
        }

        // é€‰æ‹©ä¼šè¯
        function selectSession(session) {
            currentSession = session;

            // æ›´æ–°åˆ—è¡¨é«˜äº®
            document.querySelectorAll('.session-item').forEach(item => {
                item.classList.toggle('active', item.dataset.sessionId === session.sessionId);
            });

            // æ˜¾ç¤ºå¯¹è¯è§†å›¾
            uploadArea.style.display = 'none';
            conversationView.style.display = 'flex';

            // æ›´æ–°å¤´éƒ¨ä¿¡æ¯
            document.getElementById('conversation-title').textContent = session.summary;
            document.getElementById('conversation-date').textContent = formatDateTime(session.firstTimestamp);
            document.getElementById('conversation-count').textContent = `${session.messageCount} æ¡æ¶ˆæ¯`;

            // æ¸²æŸ“æ¶ˆæ¯
            renderMessages(session.messages);
        }

        // æ¸²æŸ“æ¶ˆæ¯
        function renderMessages(messages) {
            const container = document.getElementById('conversation-messages');

            // è¿‡æ»¤æ¶ˆæ¯
            const filtered = messages.filter(msg => {
                if (currentFilter === 'all') return true;
                if (currentFilter === 'user') return msg.role === 'user';
                if (currentFilter === 'assistant') return msg.role === 'assistant' && !hasThinkingContent(msg.content);
                if (currentFilter === 'tool') return hasToolContent(msg.content);
                if (currentFilter === 'thinking') return hasThinkingContent(msg.content);
                return true;
            });

            container.innerHTML = filtered.map(msg => renderMessage(msg)).join('');

            // æ·»åŠ å·¥å…·è°ƒç”¨æŠ˜å äº‹ä»¶
            container.querySelectorAll('.tool-call-header').forEach(header => {
                header.addEventListener('click', () => {
                    header.closest('.tool-call').classList.toggle('expanded');
                });
            });
        }

        // æ¸²æŸ“å•æ¡æ¶ˆæ¯
        function renderMessage(msg) {
            const role = msg.role;
            const content = msg.content;
            const timestamp = msg.timestamp;

            let roleLabel = 'æœªçŸ¥';
            let avatar = 'â“';
            let typeClass = '';

            if (role === 'user') {
                roleLabel = 'ç”¨æˆ·';
                avatar = 'ğŸ‘¤';
                typeClass = 'message-user';
            } else if (role === 'assistant') {
                roleLabel = 'Claude';
                avatar = 'ğŸ¤–';
                typeClass = 'message-assistant';
            }

            let contentHtml = '';

            if (typeof content === 'string') {
                contentHtml = formatContent(content);
            } else if (Array.isArray(content)) {
                contentHtml = content.map(item => {
                    if (item.type === 'text') {
                        return formatContent(item.text);
                    } else if (item.type === 'thinking') {
                        return `<div class="message-content message-thinking">
                            <strong>ğŸ’­ æ€è€ƒè¿‡ç¨‹:</strong><br>
                            ${formatContent(item.thinking || '')}
                        </div>`;
                    } else if (item.type === 'tool_use') {
                        return `<div class="tool-call">
                            <div class="tool-call-header">
                                <span class="tool-call-name">ğŸ”§ ${escapeHtml(item.name || 'Tool')}</span>
                                <span class="tool-call-toggle">ç‚¹å‡»å±•å¼€</span>
                            </div>
                            <div class="tool-call-body">
                                <pre>${escapeHtml(JSON.stringify(item.input, null, 2))}</pre>
                            </div>
                        </div>`;
                    } else if (item.type === 'tool_result') {
                        return `<div class="tool-call">
                            <div class="tool-call-header">
                                <span class="tool-call-name">ğŸ“¤ å·¥å…·ç»“æœ</span>
                                <span class="tool-call-toggle">ç‚¹å‡»å±•å¼€</span>
                            </div>
                            <div class="tool-call-body">
                                <pre>${escapeHtml(typeof item.content === 'string' ? item.content : JSON.stringify(item.content, null, 2))}</pre>
                            </div>
                        </div>`;
                    }
                    return '';
                }).join('');
            }

            // å¦‚æœæ˜¯å·¥å…·ç»“æœç±»å‹çš„æ¶ˆæ¯
            if (hasToolContent(content) && !contentHtml.includes('message-content')) {
                typeClass = 'message-tool';
            }

            return `
                <div class="message ${typeClass}">
                    <div class="message-header">
                        <div class="message-avatar">${avatar}</div>
                        <span class="message-role">${roleLabel}</span>
                        ${timestamp ? `<span class="message-time">${formatTime(timestamp)}</span>` : ''}
                    </div>
                    ${contentHtml ? `<div class="message-content">${contentHtml}</div>` : ''}
                </div>
            `;
        }

        // æ£€æŸ¥æ˜¯å¦æœ‰æ€è€ƒå†…å®¹
        function hasThinkingContent(content) {
            if (Array.isArray(content)) {
                return content.some(c => c.type === 'thinking');
            }
            return false;
        }

        // æ£€æŸ¥æ˜¯å¦æœ‰å·¥å…·å†…å®¹
        function hasToolContent(content) {
            if (Array.isArray(content)) {
                return content.some(c => c.type === 'tool_use' || c.type === 'tool_result');
            }
            return false;
        }

        // æ ¼å¼åŒ–å†…å®¹ï¼ˆæ”¯æŒ Markdownï¼‰
        function formatContent(text) {
            if (!text) return '';

            let html = escapeHtml(text);

            // ä»£ç å—
            html = html.replace(/```(\w*)\n([\s\S]*?)```/g, (_, lang, code) => {
                return `<pre><code class="language-${lang}">${code.trim()}</code></pre>`;
            });

            // è¡Œå†…ä»£ç 
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

            // ç²—ä½“
            html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');

            // æ–œä½“
            html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');

            // é“¾æ¥
            html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');

            // æ¢è¡Œ
            html = html.replace(/\n/g, '<br>');

            // é«˜äº®æœç´¢è¯
            if (searchQuery) {
                const regex = new RegExp(`(${escapeRegex(searchQuery)})`, 'gi');
                html = html.replace(regex, '<span class="highlight">$1</span>');
            }

            return html;
        }

        // å¯¼å‡ºå¯¹è¯
        function exportConversation(format) {
            if (!currentSession) return;

            let content = '';
            let filename = `claude-conversation-${currentSession.sessionId}`;
            let mimeType = 'text/plain';

            if (format === 'markdown') {
                content = generateMarkdown(currentSession);
                filename += '.md';
                mimeType = 'text/markdown';
            } else if (format === 'json') {
                content = JSON.stringify(currentSession, null, 2);
                filename += '.json';
                mimeType = 'application/json';
            } else {
                content = generatePlainText(currentSession);
                filename += '.txt';
            }

            downloadFile(content, filename, mimeType);
        }

        // ç”Ÿæˆ Markdown
        function generateMarkdown(session) {
            let md = `# ${session.summary}\n\n`;
            md += `- é¡¹ç›®: ${session.project || 'æœªçŸ¥'}\n`;
            md += `- æ—¶é—´: ${formatDateTime(session.firstTimestamp)}\n`;
            md += `- æ¶ˆæ¯æ•°: ${session.messageCount}\n\n---\n\n`;

            for (const msg of session.messages) {
                const role = msg.role === 'user' ? 'ğŸ‘¤ ç”¨æˆ·' : 'ğŸ¤– Claude';
                const time = msg.timestamp ? ` (${formatTime(msg.timestamp)})` : '';
                md += `## ${role}${time}\n\n`;

                const text = extractTextContent(msg.content);
                md += `${text}\n\n`;
            }

            return md;
        }

        // ç”Ÿæˆçº¯æ–‡æœ¬
        function generatePlainText(session) {
            let text = `${session.summary}\n`;
            text += `${'='.repeat(50)}\n`;
            text += `é¡¹ç›®: ${session.project || 'æœªçŸ¥'}\n`;
            text += `æ—¶é—´: ${formatDateTime(session.firstTimestamp)}\n`;
            text += `${'='.repeat(50)}\n\n`;

            for (const msg of session.messages) {
                const role = msg.role === 'user' ? '[ç”¨æˆ·]' : '[Claude]';
                const time = msg.timestamp ? ` ${formatTime(msg.timestamp)}` : '';
                text += `${role}${time}\n`;
                text += `${'-'.repeat(30)}\n`;

                const content = extractTextContent(msg.content);
                text += `${content}\n\n`;
            }

            return text;
        }

        // ä¸‹è½½æ–‡ä»¶
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // æœç´¢å¤„ç†
        function handleSearch() {
            searchQuery = searchInput.value.trim();
            renderSessionList();

            if (currentSession) {
                renderMessages(currentSession.messages);
            }
        }

        // å·¥å…·å‡½æ•°
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function formatDate(date) {
            if (!date) return 'æœªçŸ¥';
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function formatTime(date) {
            if (!date) return '';
            return date.toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatDateTime(date) {
            if (!date) return 'æœªçŸ¥';
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getShortPath(path) {
            if (!path) return '';
            const parts = path.split('/');
            if (parts.length <= 3) return path;
            return '.../' + parts.slice(-2).join('/');
        }

        function debounce(fn, delay) {
            let timer = null;
            return function(...args) {
                clearTimeout(timer);
                timer = setTimeout(() => fn.apply(this, args), delay);
            };
        }

        // ========== è‡ªåŠ¨åŠ è½½åŠŸèƒ½ï¼ˆé€šè¿‡æœ¬åœ°æœåŠ¡å™¨ï¼‰ ==========

        // æ£€æŸ¥æ˜¯å¦é€šè¿‡æœ¬åœ°æœåŠ¡å™¨è®¿é—®
        async function checkAutoLoad() {
            const urlParams = new URLSearchParams(window.location.search);
            if (!urlParams.has('auto')) return;

            try {
                sessionList.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';

                const response = await fetch('/api/sessions');
                if (!response.ok) throw new Error('API ä¸å¯ç”¨');

                const data = await response.json();
                if (data.error) {
                    console.warn('åŠ è½½è­¦å‘Š:', data.error);
                }

                if (data.sessions && data.sessions.length > 0) {
                    // è½¬æ¢ä¸ºæœ¬åœ°æ ¼å¼
                    for (const session of data.sessions) {
                        session.firstTimestamp = session.firstTimestamp ? new Date(session.firstTimestamp) : null;
                        session.lastTimestamp = session.lastTimestamp ? new Date(session.lastTimestamp) : null;
                        session.messages = []; // æ¶ˆæ¯å»¶è¿ŸåŠ è½½
                    }

                    allSessions = data.sessions;
                    updateStats();
                    renderSessionList();
                    uploadArea.style.display = 'none';
                    statsPanel.style.display = 'grid';

                    console.log(`å·²è‡ªåŠ¨åŠ è½½ ${allSessions.length} ä¸ªå¯¹è¯`);
                }
            } catch (err) {
                console.log('è‡ªåŠ¨åŠ è½½ä¸å¯ç”¨ï¼Œä½¿ç”¨æ‰‹åŠ¨å¯¼å…¥æ¨¡å¼');
            }
        }

        // é‡å†™é€‰æ‹©ä¼šè¯å‡½æ•°ä»¥æ”¯æŒå»¶è¿ŸåŠ è½½
        const originalSelectSession = selectSession;
        selectSession = async function(session) {
            // å¦‚æœæ¶ˆæ¯ä¸ºç©ºä¸”é€šè¿‡ API è®¿é—®ï¼Œåˆ™åŠ è½½æ¶ˆæ¯
            if (session.messages.length === 0 && session.filepath) {
                try {
                    const response = await fetch(`/api/session/${encodeURIComponent(session.filepath)}`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.messages) {
                            session.messages = data.messages.map(msg => ({
                                ...msg,
                                timestamp: msg.timestamp ? new Date(msg.timestamp) : null
                            }));
                            session.messageCount = session.messages.length;
                        }
                    }
                } catch (err) {
                    console.error('åŠ è½½æ¶ˆæ¯å¤±è´¥:', err);
                }
            }

            currentSession = session;

            // æ›´æ–°åˆ—è¡¨é«˜äº®
            document.querySelectorAll('.session-item').forEach(item => {
                item.classList.toggle('active', item.dataset.sessionId === session.sessionId);
            });

            // æ˜¾ç¤ºå¯¹è¯è§†å›¾
            uploadArea.style.display = 'none';
            conversationView.style.display = 'flex';

            // æ›´æ–°å¤´éƒ¨ä¿¡æ¯
            document.getElementById('conversation-title').textContent = session.summary;
            document.getElementById('conversation-date').textContent = formatDateTime(session.firstTimestamp);
            document.getElementById('conversation-count').textContent = `${session.messageCount} æ¡æ¶ˆæ¯`;

            // æ¸²æŸ“æ¶ˆæ¯
            renderMessages(session.messages);
        };

        // é¡µé¢åŠ è½½æ—¶å°è¯•è‡ªåŠ¨åŠ è½½
        checkAutoLoad();
    </script>
</body>
</html>
